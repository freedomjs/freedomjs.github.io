/**
 * This is freedom.js. - https://freedomjs.org
 *
 * Copyright 2013 The freedom.js authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * @license apache2.0
 * @see https://freedomjs.org
 */
!function(global){"use strict";!function a(){function b(a,b,c,d){var e,f,g,h;if(this.peerName=a,this.channels={},this.dataChannelCallbacks=c,"undefined"!=typeof d.RTCPeerConnection)e=d.RTCPeerConnection;else if("undefined"!=typeof webkitRTCPeerConnection)e=webkitRTCPeerConnection;else{if("undefined"==typeof mozRTCPeerConnection)throw new Error("This environment does not seem to support RTCPeerConnection");e=mozRTCPeerConnection}for(this.RTCSessionDescription="undefined"!=typeof d.RTCSessionDescription?d.RTCSessionDescription:RTCSessionDescription,f={optional:[{DtlsSrtpKeyAgreement:!0}]},this.sendSignalMessage=null,this.pc=null,g={iceServers:[]},h=0;h<b.length;h+=1)g.iceServers.push({url:b[h]});this.pc=new e(g,f),this.pc.addEventListener("icecandidate",this.onIceCallback.bind(this)),this.pc.addEventListener("negotiationneeded",this.onNegotiationNeeded.bind(this)),this.pc.addEventListener("datachannel",this.onDataChannel.bind(this)),this.pc.addEventListener("signalingstatechange",function(){"stable"===this.pc.signalingState&&(this.pcState=l.CONNECTED)}.bind(this)),this.pcState=l.DISCONNECTED}function c(a,b,c,d){this.dispatchEvent=b,this.peerName="p"+Math.random(),this.freedomModule=a,this.RTCPeerConnection=c,this.RTCSessionDescription=d,this.signallingChannel=null,this.peer=null,this.freedomModule.once("core",function(a){this.core=new a}.bind(this)),this.freedomModule.emit(this.freedomModule.controlChannel,{type:"core request delegated to peerconnection",request:"core"})}function d(a,b,c,d,e){var f;f=e?e:WebSocket,this.dispatchEvent=b;try{this.websocket=d&&d.length>0?new f(c,d):new f(c)}catch(g){var h={};return h.errcode=g instanceof SyntaxError?"SYNTAX":g.name,h.message=g.message,void b("onError",h)}this.websocket.onopen=this.onOpen.bind(this),this.websocket.onclose=this.onClose.bind(this),this.websocket.onmessage=this.onMessage.bind(this),this.websocket.onerror=this.onError.bind(this)}var e,f="(function (global) {'use strict';("+a+")();})(this);";if("undefined"==typeof global.freedom){if("undefined"==typeof g)var g=global;!function(){var a,b,c,d;!function(){var e={},f={};a=function(a,b,c){e[a]={deps:b,callback:c}},d=c=b=function(a){function c(b){if("."!==b.charAt(0))return b;for(var c=b.split("/"),d=a.split("/").slice(0,-1),e=0,f=c.length;f>e;e++){var g=c[e];if(".."===g)d.pop();else{if("."===g)continue;d.push(g)}}return d.join("/")}if(d._eak_seen=e,f[a])return f[a];if(f[a]={},!e[a])throw new Error("Could not find module "+a);for(var g,h=e[a],i=h.deps,j=h.callback,k=[],l=0,m=i.length;m>l;l++)k.push("exports"===i[l]?g={}:b(c(i[l])));var n=j.apply(this,k);return f[a]=g||n}}(),a("promise/all",["./utils","exports"],function(a,b){function c(a){var b=this;if(!d(a))throw new TypeError("You must pass an array to all.");return new b(function(b,c){function d(a){return function(b){f(a,b)}}function f(a,c){h[a]=c,0===--i&&b(h)}var g,h=[],i=a.length;0===i&&b([]);for(var j=0;j<a.length;j++)g=a[j],g&&e(g.then)?g.then(d(j),c):f(j,g)})}var d=a.isArray,e=a.isFunction;b.all=c}),a("promise/asap",["exports"],function(a){function b(){return function(){process.nextTick(e)}}function c(){var a=0,b=new j(e),c=document.createTextNode("");return b.observe(c,{characterData:!0}),function(){c.data=a=++a%2}}function d(){return function(){k.setTimeout(e,1)}}function e(){for(var a=0;a<l.length;a++){var b=l[a],c=b[0],d=b[1];c(d)}l=[]}function f(a,b){var c=l.push([a,b]);1===c&&h()}var h,i="undefined"!=typeof g?g:{},j=i.MutationObserver||i.WebKitMutationObserver,k="undefined"!=typeof global?global:this,l=[];h="undefined"!=typeof process&&"[object process]"==={}.toString.call(process)?b():j?c():d(),a.asap=f}),a("promise/cast",["exports"],function(a){function b(a){if(a&&"object"==typeof a&&a.constructor===this)return a;var b=this;return new b(function(b){b(a)})}a.cast=b}),a("promise/config",["exports"],function(a){function b(a,b){return 2!==arguments.length?c[a]:void(c[a]=b)}var c={instrument:!1};a.config=c,a.configure=b}),a("promise/polyfill",["./promise","./utils","exports"],function(a,b,c){function d(){var a="Promise"in g&&"cast"in g.Promise&&"resolve"in g.Promise&&"reject"in g.Promise&&"all"in g.Promise&&"race"in g.Promise&&function(){var a;return new g.Promise(function(b){a=b}),f(a)}();a||(g.Promise=e)}var e=a.Promise,f=b.isFunction;c.polyfill=d}),a("promise/promise",["./config","./utils","./cast","./all","./race","./resolve","./reject","./asap","exports"],function(a,b,c,d,e,f,g,h,i){function j(a){if(!w(a))throw new TypeError("You must pass a resolver function as the first argument to the promise constructor");if(!(this instanceof j))throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.");this._subscribers=[],k(a,this)}function k(a,b){function c(a){p(b,a)}function d(a){r(b,a)}try{a(c,d)}catch(e){d(e)}}function l(a,b,c,d){var e,f,g,h,i=w(c);if(i)try{e=c(d),g=!0}catch(j){h=!0,f=j}else e=d,g=!0;o(b,e)||(i&&g?p(b,e):h?r(b,f):a===F?p(b,e):a===G&&r(b,e))}function m(a,b,c,d){var e=a._subscribers,f=e.length;e[f]=b,e[f+F]=c,e[f+G]=d}function n(a,b){for(var c,d,e=a._subscribers,f=a._detail,g=0;g<e.length;g+=3)c=e[g],d=e[g+b],l(b,c,d,f);a._subscribers=null}function o(a,b){var c,d=null;try{if(a===b)throw new TypeError("A promises callback cannot return that same promise.");if(v(b)&&(d=b.then,w(d)))return d.call(b,function(d){return c?!0:(c=!0,void(b!==d?p(a,d):q(a,d)))},function(b){return c?!0:(c=!0,void r(a,b))}),!0}catch(e){return c?!0:(r(a,e),!0)}return!1}function p(a,b){a===b?q(a,b):o(a,b)||q(a,b)}function q(a,b){a._state===D&&(a._state=E,a._detail=b,u.async(s,a))}function r(a,b){a._state===D&&(a._state=E,a._detail=b,u.async(t,a))}function s(a){n(a,a._state=F)}function t(a){n(a,a._state=G)}var u=a.config,v=(a.configure,b.objectOrFunction),w=b.isFunction,x=(b.now,c.cast),y=d.all,z=e.race,A=f.resolve,B=g.reject,C=h.asap;u.async=C;var D=void 0,E=0,F=1,G=2;j.prototype={constructor:j,_state:void 0,_detail:void 0,_subscribers:void 0,then:function(a,b){var c=this,d=new this.constructor(function(){});if(this._state){var e=arguments;u.async(function(){l(c._state,d,e[c._state-1],c._detail)})}else m(this,d,a,b);return d},"catch":function(a){return this.then(null,a)}},j.all=y,j.cast=x,j.race=z,j.resolve=A,j.reject=B,i.Promise=j}),a("promise/race",["./utils","exports"],function(a,b){function c(a){var b=this;if(!d(a))throw new TypeError("You must pass an array to race.");return new b(function(b,c){for(var d,e=0;e<a.length;e++)d=a[e],d&&"function"==typeof d.then?d.then(b,c):b(d)})}var d=a.isArray;b.race=c}),a("promise/reject",["exports"],function(a){function b(a){var b=this;return new b(function(b,c){c(a)})}a.reject=b}),a("promise/resolve",["exports"],function(a){function b(a){var b=this;return new b(function(b){b(a)})}a.resolve=b}),a("promise/utils",["exports"],function(a){function b(a){return c(a)||"object"==typeof a&&null!==a}function c(a){return"function"==typeof a}function d(a){return"[object Array]"===Object.prototype.toString.call(a)}var e=Date.now||function(){return(new Date).getTime()};a.objectOrFunction=b,a.isFunction=c,a.isArray=d,a.now=e}),b("promise/polyfill").polyfill()}(),"undefined"==typeof e&&(e={});var h=function(){this.apis={},this.providers={},this.waiters={}};h.prototype.get=function(a){return this.apis[a]?{name:a,definition:this.apis[a]}:!1},h.prototype.set=function(a,b){this.apis[a]=b},h.prototype.register=function(a,b){var c;if(this.providers[a]=b,this.waiters[a]){for(c=0;c<this.waiters[a].length;c+=1)this.waiters[a][c][0](b.bind({},this.waiters[a][c][2]));delete this.waiters[a]}},h.prototype.getCore=function(a,b){return new Promise(function(c,d){this.apis[a]?this.providers[a]?c(this.providers[a].bind({},b)):(this.waiters[a]||(this.waiters[a]=[]),this.waiters[a].push([c,d,b])):(e.debug.warn("Api.getCore asked for unknown core: "+a),d(null))}.bind(this))},e.apis=new h,"undefined"==typeof e&&(e={}),e.setup=function(global,a,b){e.debug=new e.port.Debug;var c,d=new e.Hub,f={debug:!0,stayLocal:!1,portType:"Worker",appContext:b&&"undefined"!=typeof b.isApp?b.isApp:e.util.isAppContext()},g=new e.port.Manager(d),h=new e.port.Proxy(e.proxy.EventInterface),i=function(a){g.setup(a),g.createLink(h,"default",a)};return g.setup(h),f.appContext?(b&&e.util.mixin(f,b,!0),f.global=global,f.src=a,i(new e.link[f.portType]),g.once("delegate",g.setup.bind(g,e.debug))):(g.setup(e.debug),e.util.advertise(b?b.advertise:void 0),"undefined"!=typeof document&&e.util.eachReverse(e.util.scripts(global),function(a){var b=a.getAttribute("data-manifest"),c=a.src;if(b){if(f.source=c,f.manifest=b,a.textContent.trim().length)try{e.util.mixin(f,JSON.parse(a.textContent),!0)}catch(d){e.debug.warn("Failed to parse configuration: "+d)}return!0}}),f.global=global,f.src=a,f.resources=e.resources,b&&e.util.mixin(f,b,!0),f.stayLocal||(c=new e.port.Runtime,g.setup(c)),"undefined"!=typeof location?c=location.protocol+"//"+location.host+location.pathname:f.location&&(c=f.location),e.resources.get(c,f.manifest).then(function(a){i(new e.port.Module(a,[]))})),d.emit("config",f),"undefined"==typeof global.console&&(global.console=e.debug),h.getInterface()},"undefined"==typeof e&&(e={}),e.Hub=function(){this.route=Math.round(1e6*Math.random()),this.config={},this.apps={},this.routes={},this.unbound=[],e.util.handleEvents(this),this.on("config",function(a){e.util.mixin(this.config,a)}.bind(this))},e.Hub.prototype.onMessage=function(a,b){var c=this.routes[a];if(!c||!c.app)return void e.debug.warn("Message dropped from unregistered source "+a);if(!this.apps[c.app])return void e.debug.warn("Message dropped to destination "+c.app);if(!b.quiet){var d=b.type;"message"===b.type&&b.message&&"method"===b.message.action?d="method."+b.message.type:"method"===b.type&&b.message&&"method"===b.message.type?d="return."+b.message.name:"message"===b.type&&b.message&&"event"===b.message.type&&(d="event."+b.message.name),e.debug.log(this.apps[c.source].toString()+" -"+d+"-> "+this.apps[c.app].toString()+"."+c.flow)}this.apps[c.app].onMessage(c.flow,b)},e.Hub.prototype.getDestination=function(a){var b=this.routes[a];return b?this.apps[b.app]:null},e.Hub.prototype.getSource=function(a){return a?this.apps[a.id]?this.apps[a.id]:(e.debug.warn("No registered source '"+a.id+"'"),!1):!1},e.Hub.prototype.register=function(a,b){return!this.apps[a.id]||b?(this.apps[a.id]=a,!0):!1},e.Hub.prototype.deregister=function(a){return this.apps[a.id]?(delete this.apps[a.id],!0):!1},e.Hub.prototype.install=function(a,b,c){if(a=this.getSource(a)){if(!b)return void e.debug.warn("Unwilling to generate blackhole flow from "+a.id);var d=this.generateRoute();return this.routes[d]={app:b,flow:c,source:a.id},"function"==typeof a.on&&a.on(d,this.onMessage.bind(this,d)),d}},e.Hub.prototype.uninstall=function(a,b){if(a=this.getSource(a)){var c=this.routes[b];return c?c.source!==a.id?(e.debug.warn("Flow "+b+" does not belong to port "+a.id),!1):(delete this.routes[b],"function"==typeof a.off&&a.off(c),!0):!1}},e.Hub.prototype.generateRoute=function(){return this.route+=1},"undefined"==typeof e&&(e={}),e.Link=function(){this.id="Link"+Math.random(),this.config={},this.src=null,e.util.handleEvents(this),e.util.mixin(this,e.Link.prototype)},e.Link.prototype.onMessage=function(a,b){"control"!==a||this.controlChannel?this.deliverMessage(a,b):!this.controlChannel&&b.channel&&(this.controlChannel=b.channel,e.util.mixin(this.config,b.config),this.start())},e.Link.prototype.emitMessage=function(a,b){"control"===a&&this.controlChannel&&(a=this.controlChannel),this.emit(a,b)},"undefined"==typeof e&&(e={}),e.port=e.port||{},e.port.Debug=function(){this.id="debug",this.emitChannel=!1,this.console=null,this.config=!1,e.util.handleEvents(this)},e.port.Debug.prototype.toString=function(){return"[Console]"},e.port.Debug.prototype.onMessage=function(a,b){"control"===a&&b.channel&&!this.emitChannel&&(this.emitChannel=b.channel,this.config=b.config.debug,this.console=b.config.global.console,this.emit("ready"))},e.port.Debug.prototype.format=function(a,b,c){var d,e=[];if("string"==typeof c)e.push(c);else for(d=0;d<c.length;d+=1)e.push(c[d]);return this.emitChannel?void this.emit(this.emitChannel,{severity:a,source:b,quiet:!0,request:"debug",msg:JSON.stringify(e)}):void this.on("ready",this.format.bind(this,a,b,e))},e.port.Debug.prototype.print=function(a){var b,c=Boolean(this.config),d=[],e=0;if("string"==typeof this.config)for(c=!1,b=this.config.split(" "),e=0;e<b.length;e+=1)if(0===b[e].indexOf("source:")){if(void 0===a.source||a.source.indexOf(b[e].substr(7))>-1){c=!0;break}}else if(a.msg.indexOf(b[e])>-1){c=!0;break}if(c&&"undefined"!=typeof this.console&&this.console!==this){if(b=JSON.parse(a.msg),"string"==typeof b)d.push(b);else for(;void 0!==b[e];)d.push(b[e]),e+=1;"undefined"!=typeof process&&a.source?(d.unshift("[39m"),d.unshift("[31m"+a.source)):a.source&&(d.unshift("color: red"),d.unshift("%c "+a.source)),!this.console[a.severity]&&this.console.log&&(a.severity="log"),this.console[a.severity].apply(this.console,d)}},e.port.Debug.prototype.log=function(){this.format("log",void 0,arguments)},e.port.Debug.prototype.warn=function(){this.format("warn",void 0,arguments)},e.port.Debug.prototype.error=function(){this.format("error",void 0,arguments)},"undefined"==typeof e&&(e={}),e.port=e.port||{},e.port.Manager=function(a){this.id="control",this.config={},this.controlFlows={},this.dataFlows={},this.dataFlows[this.id]=[],this.reverseFlowMap={},this.hub=a,this.delegate=null,this.toDelegate={},this.hub.on("config",function(a){e.util.mixin(this.config,a),this.emit("config")}.bind(this)),e.util.handleEvents(this),this.hub.register(this)},e.port.Manager.prototype.toString=function(){return"[Local Controller]"},e.port.Manager.prototype.onMessage=function(a,b){var c,d=this.controlFlows[a];if(!d)return void e.debug.warn("Unknown message source: "+a);if(c=this.hub.getDestination(d),this.delegate&&d!==this.delegate&&this.toDelegate[a])return void this.emit(this.delegate,{type:"Delegation",request:"handle",quiet:!0,flow:a,message:b});if("debug"===b.request)return void(this.config.debug&&e.debug.print(b));if("link"===b.request)this.createLink(c,b.name,b.to,b.overrideDest);else if("port"===b.request)b.exposeManager&&(b.args=this),this.createLink(c,b.name,new e.port[b.service](b.args));else if("bindport"===b.request)this.createLink({id:b.id},"custom"+b.port,new e.port[b.service](b.args),"default",!0);else if("delegate"===b.request)null===this.delegate&&(this.delegate=d),this.toDelegate[b.flow]=!0,this.emit("delegate");else if("resource"===b.request)e.resources.addResolver(b.args[0]),e.resources.addRetriever(b.service,b.args[1]);else if("core"===b.request){if(this.core&&d===this.delegate)return void(new this.core).onMessage(c,b.message);this.getCore(function(a,b){this.hub.onMessage(a,{type:"core",core:b})}.bind(this,d))}else if("close"===b.request)this.destroy(c);else{if("unlink"!==b.request)return e.debug.warn("Unknown control request: "+b.request),void e.debug.log(JSON.stringify(b));this.removeLink(c,b.to)}},e.port.Manager.prototype.setup=function(a){if(!a.id)return e.debug.warn("Refusing to setup unidentified port "),!1;if(this.controlFlows[a.id])return e.debug.warn("Refusing to re-initialize port "+a.id),!1;if(!this.config.global)return void this.once("config",this.setup.bind(this,a));this.hub.register(a);var b=this.hub.install(this,a.id,"control"),c=this.hub.install(a,this.id,a.id);return this.controlFlows[a.id]=b,this.dataFlows[a.id]=[c],this.reverseFlowMap[b]=c,this.reverseFlowMap[c]=b,this.hub.onMessage(b,{type:"setup",channel:c,config:this.config}),!0},e.port.Manager.prototype.destroy=function(a){if(!a.id)return e.debug.warn("Unable to tear down unidentified port"),!1;delete this.controlFlows[a.id];var b;for(b=this.dataFlows[a.id].length-1;b>=0;b-=1)this.removeLink(a,this.dataFlows[a.id][b]);delete this.dataFlows[a.id],this.hub.deregister(a)},e.port.Manager.prototype.createLink=function(a,b,c,d,f){if(!this.config.global)return void this.once("config",this.createLink.bind(this,a,b,c,d));if(!this.controlFlows[a.id])return void e.debug.warn("Unwilling to link from non-registered source.");if(!this.controlFlows[c.id]&&this.setup(c)===!1)return void e.debug.warn("Could not find or setup destination.");var g,h=d||"default",i=this.hub.install(a,c.id,h);c=this.hub.getDestination(i),g=this.hub.install(c,a.id,b),this.reverseFlowMap[i]=g,this.dataFlows[a.id].push(i),this.reverseFlowMap[g]=i,this.dataFlows[c.id].push(g),f?this.hub.onMessage(this.controlFlows[c.id],{type:"createLink",name:h,channel:g,reverse:i}):this.hub.onMessage(this.controlFlows[a.id],{name:b,type:"createLink",channel:i,reverse:g})},e.port.Manager.prototype.removeLink=function(a,b){var c,d=this.hub.getDestination(b),f=this.reverseFlowMap[b];return d&&f?this.hub.getDestination(f).id!==a.id?void e.debug.warn("Source port does not own flow "+b):(c=this.controlFlows[a.id],c&&this.hub.onMessage(c,{type:"close",channel:b}),c=this.controlFlows[d.id],c&&this.hub.onMessage(c,{type:"close",channel:f}),this.hub.uninstall(a,b),this.hub.uninstall(d,f),delete this.reverseFlowMap[b],delete this.reverseFlowMap[f],this.forgetFlow(d.id,f),void this.forgetFlow(a.id,b)):void e.debug.warn("Could not find metadata to remove flow: "+b)},e.port.Manager.prototype.forgetFlow=function(a,b){var c;if(this.dataFlows[a])for(c=0;c<this.dataFlows[a].length;c+=1)if(this.dataFlows[a][c]===b){this.dataFlows[a].splice(c,1);break}},e.port.Manager.prototype.getCore=function(a){this.core?a(this.core):e.apis.getCore("core",this).then(function(b){this.core=b,a(this.core)}.bind(this))},"undefined"==typeof e&&(e={}),e.port=e.port||{},e.port.Module=function(a,b){this.config={},this.id=a+Math.random(),this.manifestId=a,this.lineage=[this.manifestId].concat(b),this.loadManifest(),this.externalPortMap={},this.internalPortMap={},this.started=!1,e.util.handleEvents(this)},e.port.Module.prototype.onMessage=function(a,b){if("control"===a){if("setup"===b.type)return this.controlChannel=b.channel,e.util.mixin(this.config,b.config),this.emit(this.controlChannel,{type:"Core Provider",request:"core"}),void this.start();if("createLink"===b.type&&b.channel)return this.externalPortMap[b.name]=b.channel,void 0===this.internalPortMap[b.name]&&(this.internalPortMap[b.name]=!1),void this.emit(b.channel,{type:"default channel announcement",channel:b.reverse});if(b.core)return this.core=new b.core,void this.emit("core",b.core);"close"===b.type?(("default"===b.channel||"control"===b.channel)&&this.stop(),this.deregisterFlow(b.channel,!1)):this.port.onMessage(a,b)}else{if(this.externalPortMap[a]===!1&&b.channel)return this.externalPortMap[a]=b.channel,void 0===this.internalPortMap[a]&&(this.internalPortMap[a]=!1),void(this.manifest.provides&&"default"===a&&(this.externalPortMap[this.manifest.provides[0]]=b.channel));this.started?this.internalPortMap[a]===!1?this.once("internalChannelReady",this.onMessage.bind(this,a,b)):this.port.onMessage(this.internalPortMap[a],b):this.once("start",this.onMessage.bind(this,a,b))}},e.port.Module.prototype.deregisterFlow=function(a,b){var c,d=b?this.internalPortMap:this.externalPortMap;for(c in d)if(d[c]===a)return b?this.emit(this.controlChannel,{type:"Channel Teardown",request:"unlink",to:this.externalPortMap[c]}):this.port.onMessage("control",{type:"close",channel:this.internalPortMap[c]}),delete this.externalPortMap[c],delete this.internalPortMap[c],!0;return!1},e.port.Module.prototype.start=function(){return this.started||this.port?!1:void(this.manifest&&this.controlChannel&&(this.loadLinks(),this.port=new e.link[this.config.portType](this.manifestId),this.port.on(this.emitMessage.bind(this)),this.port.onMessage("control",{channel:"control",config:this.config}),this.port.onMessage("control",{type:"Redirect",request:"delegate",flow:"debug"}),this.port.onMessage("control",{type:"Redirect",request:"delegate",flow:"core"}),this.port.onMessage("control",{type:"Environment Configuration",request:"port",name:"ModInternal",service:"ModuleInternal",exposeManager:!0})))},e.port.Module.prototype.stop=function(){this.started&&(this.port&&(this.port.off(),this.port.onMessage("control",{type:"close",channel:"control"}),delete this.port),this.started=!1)},e.port.Module.prototype.toString=function(){var a=this.manifestId;return a.indexOf("/")>-1&&(a=a.substr(a.lastIndexOf("/")+1)),"[Module "+a+"]"},e.port.Module.prototype.emitMessage=function(a,b){if(this.internalPortMap[a]===!1&&b.channel)return this.internalPortMap[a]=b.channel,void this.emit("internalChannelReady");if("control"===a)if("debug"===b.flow&&b.message)e.debug.format(b.message.severity,this.toString(),b.message.msg);else if("core"===b.flow&&b.message){if(!this.core)return void this.once("core",this.emitMessage.bind(this,a,b));"register"===b.message.type&&(b.message.reply=this.port.onMessage.bind(this.port,"control"),this.externalPortMap[b.message.id]=!1),this.core.onMessage(this,b.message)}else"ModInternal"!==b.name||this.modInternal?"createLink"===b.type?(this.manifest.provides&&0===this.manifest.provides.indexOf(b.name)&&(this.internalPortMap["default"]=b.channel),this.internalPortMap[b.name]=b.channel,this.port.onMessage(b.channel,{type:"channel announcement",channel:b.reverse}),this.emit("internalChannelReady")):"close"===b.type&&this.deregisterFlow(b.channel,!0):(this.modInternal=b.channel,this.port.onMessage(this.modInternal,{type:"Initialization",id:this.manifestId,appId:this.id,manifest:this.manifest,lineage:this.lineage,channel:b.reverse}),this.emit("modInternal"));else"ModInternal"!==a||"ready"!==b.type||this.started?"ModInternal"===a&&"resolve"===b.type?e.resources.get(this.manifestId,b.data).then(function(a,b){this.port.onMessage(this.modInternal,{type:"resolve response",id:a,data:b})}.bind(this,b.id),function(){e.debug.warn("Error Resolving URL for Module.")}):this.emit(this.externalPortMap[a],b):(this.started=!0,this.emit("start"));return!1},e.port.Module.prototype.loadManifest=function(){e.resources.getContents(this.manifestId).then(function(a){var b={};try{b=JSON.parse(a)}catch(c){return void e.debug.warn("Failed to load "+this.manifestId+": "+c)}this.manifest=b,this.emit("manifest",this.manifest),this.start()}.bind(this),function(a){e.debug.warn("Failed to load "+this.manifestId+": "+a)}.bind(this))},e.port.Module.prototype.loadLinks=function(){var a,b,c,d=["default"],f=function(a,b){a.getInterface().provideAsynchronous(b)};if(this.manifest.permissions)for(a=0;a<this.manifest.permissions.length;a+=1)b=this.manifest.permissions[a],d.indexOf(b)<0&&0===b.indexOf("core.")&&(d.push(b),c=new e.port.Provider(e.apis.get(b).definition),e.apis.getCore(b,this).then(f.bind(this,c)),this.emit(this.controlChannel,{type:"Link to "+b,request:"link",name:b,to:c}));for(this.manifest.dependencies&&e.util.eachProp(this.manifest.dependencies,function(a,b){d.indexOf(b)<0&&d.push(b),e.resources.get(this.manifestId,a.url).then(function(a){var c=new e.port.Module(a,this.lineage);c.once("manifest",this.updateEnv.bind(this,b)),this.emit(this.controlChannel,{type:"Link to "+b,request:"link",name:b,to:c})}.bind(this))}.bind(this)),a=0;a<d.length;a+=1)this.externalPortMap[d[a]]=this.externalPortMap[d[a]]||!1,this.internalPortMap[d[a]]=!1},e.port.Module.prototype.updateEnv=function(a,b){if(b){this.modInternal||this.once("modInternal",this.updateEnv.bind(this,a,b));var c={name:b.name,icon:b.icon,description:b.description};this.port.onMessage(this.modInternal,{type:"manifest",name:a,manifest:c})}},e.port.Module.prototype.serialize=function(){return JSON.serialize({manifestId:this.manifestId,externalPortMap:this.externalPortMap,internalPortMap:this.internalPortMap,manifest:this.manifest,controlChannel:this.controlChannel})},"undefined"==typeof e&&(e={}),e.port=e.port||{},e.port.ModuleInternal=function(a){this.config={},this.manager=a,this.manifests={},this.id="ModuleInternal-"+Math.random(),this.pendingPorts=0,this.requests={},e.util.handleEvents(this)},e.port.ModuleInternal.prototype.onMessage=function(a,b){if("control"===a)!this.controlChannel&&b.channel&&(this.controlChannel=b.channel,e.util.mixin(this.config,b.config));else if("default"!==a||this.appId)"default"===a&&this.requests[b.id]?(this.requests[b.id](b.data),delete this.requests[b.id]):"default"===a&&"manifest"===b.type&&this.updateManifest(b.name,b.manifest);else{this.port=this.manager.hub.getDestination(b.channel),this.externalChannel=b.channel,this.appId=b.appId,this.lineage=b.lineage;var c=this.mapProxies(b.manifest);this.once("start",this.loadScripts.bind(this,b.id,b.manifest.app.script)),this.loadLinks(c)}},e.port.ModuleInternal.prototype.toString=function(){return"[Module Environment Helper]"},e.port.ModuleInternal.prototype.attach=function(a,b,c){var d=this.config.global.freedom;d[a]||(d[a]=b.getProxyInterface(),c&&(d[a].api=c),this.manifests[a]&&(d[a].manifest=this.manifests[a])),this.pendingPorts-=1,0===this.pendingPorts&&this.emit("start")},e.port.ModuleInternal.prototype.loadLinks=function(a){var b,c,d,f,g;for(b=0;b<a.length;b+=1)g=void 0,a[b].def?(g=a[b].def.name,c=a[b].provides?new e.port.Provider(a[b].def.definition):new e.port.Proxy(e.proxy.ApiInterface.bind({},a[b].def.definition))):c=new e.port.Proxy(e.proxy.EventInterface),c.once("start",this.attach.bind(this,a[b].name,c,g)),this.manager.createLink(this.port,a[b].name,c),this.pendingPorts+=1;e.resources.addResolver(function(a,b,c){var d=Math.random();return this.requests[d]=c,this.emit(this.externalChannel,{type:"resolve",id:d,data:b}),!0}.bind(this)),this.pendingPorts+=1,f=e.apis.get("core").definition,d=new e.port.Provider(f),this.manager.getCore(function(a){new a(this.manager).setId(this.lineage),d.getInterface().provideAsynchronous(a)}.bind(this)),this.emit(this.controlChannel,{type:"Link to core",request:"link",name:"core",to:d}),c=new e.port.Proxy(e.proxy.ApiInterface.bind({},f)),this.manager.createLink(d,"default",c),this.attach("core",c),0===this.pendingPorts&&this.emit("start")},e.port.ModuleInternal.prototype.updateManifest=function(a,b){var c=this.config.global.freedom;c[a]?c[a].manifest=b:this.manifests[a]=b},e.port.ModuleInternal.prototype.mapProxies=function(a){var b,c,d=[],f=["core"];if(a.permissions)for(b=0;b<a.permissions.length;b+=1)c={name:a.permissions[b],def:void 0},c.def=e.apis.get(c.name),f.indexOf(c.name)<0&&c.def&&(d.push(c),f.push(c.name));if(a.dependencies&&e.util.eachProp(a.dependencies,function(a,b){c={name:b},f.indexOf(b)<0&&(a.api&&(c.def=e.apis.get(a.api)),d.push(c),f.push(b))}),a.provides)for(b=0;b<a.provides.length;b+=1)c={name:a.provides[b],def:void 0,provides:!0},c.def=e.apis.get(c.name),f.indexOf(c.name)<0&&c.def&&(d.push(c),f.push(c.name));return d},e.port.ModuleInternal.prototype.loadScripts=function(a,b){var c=0,d=!0,f=function(a,b){this.config.global.importScripts(a),b()}.bind(this),g=[],h=0,i=function(a){g.push(a),h-=1,0===h&&(d?(this.emit(this.externalChannel,{type:"ready"}),this.tryLoad(f,g)):this.tryLoad(f,g).then(function(){this.emit(this.externalChannel,{type:"ready"})}.bind(this)))}.bind(this);if(this.config.global.importScripts||(d=!1,f=function(a,b){var c=this.config.global.document.createElement("script");c.src=a,c.addEventListener("load",b,!0),this.config.global.document.body.appendChild(c)}.bind(this)),"string"==typeof b)h=1,e.resources.get(a,b).then(i);else for(h=b.length,c=0;c<b.length;c+=1)e.resources.get(a,b[c]).then(i)},e.port.ModuleInternal.prototype.tryLoad=function(a,b){var c,d=[];try{for(c=0;c<b.length;c+=1)d.push(new Promise(a.bind({},b[c])))}catch(f){e.debug.warn(f.stack),e.debug.error("Error loading "+b[c],f),e.debug.error("If the stack trace is not useful, see https://github.com/UWNetworksLab/freedom/wiki/Debugging-Script-Parse-Errors")}return Promise.all(d)},"undefined"==typeof e&&(e={}),e.port=e.port||{},e.port.Provider=function(a){this.id=e.port.Proxy.nextId(),e.util.handleEvents(this),this.definition=a,this.mode=e.port.Provider.mode.synchronous,this.iface=null,this.providerCls=null,this.providerInstances={}},e.port.Provider.mode={synchronous:0,asynchronous:1,promises:2},e.port.Provider.prototype.onMessage=function(a,b){if("control"===a&&b.reverse)this.emitChannel=b.channel,this.emit(this.emitChannel,{type:"channel announcement",channel:b.reverse}),this.emit("start");else if("control"===a&&"setup"===b.type)this.controlChannel=b.channel;else if("control"===a&&"close"===b.type)b.channel===this.controlChannel&&delete this.controlChannel,this.close();else if("default"===a){if(!this.emitChannel&&b.channel)return this.emitChannel=b.channel,void this.emit("start");if("close"===b.type&&b.to)delete this.providerInstances[b.to];else if(b.to&&this.providerInstances[b.to])b.message.to=b.to,this.providerInstances[b.to](b.message);else if(b.to&&b.message&&"construct"===b.message.type){var c=e.proxy.portableToMessage(this.definition.constructor?this.definition.constructor.value:[],b.message);this.providerInstances[b.to]=this.getProvider(b.to,c)}else e.debug.warn(this.toString()+" dropping message "+JSON.stringify(b))}},e.port.Provider.prototype.close=function(){this.controlChannel&&(this.emit(this.controlChannel,{type:"Provider Closing",request:"close"}),delete this.controlChannel),this.emit("close"),this.providerInstances={},this.emitChannel=null},e.port.Provider.prototype.getInterface=function(){return this.iface?this.iface:(this.iface={provideSynchronous:function(a){this.providerCls=a,this.mode=e.port.Provider.mode.synchronous}.bind(this),provideAsynchronous:function(a){this.providerCls=a,this.mode=e.port.Provider.mode.asynchronous}.bind(this),providePromises:function(a){this.providerCls=a,this.mode=e.port.Provider.mode.promises}.bind(this),close:function(){this.close()}.bind(this)},e.util.eachProp(this.definition,function(a,b){switch(a.type){case"constant":Object.defineProperty(this.iface,b,{value:e.proxy.recursiveFreezeObject(a.value),writable:!1})}}.bind(this)),this.iface)},e.port.Provider.prototype.getProxyInterface=function(){var a=function(a){return a.getInterface()}.bind({},this);return a.close=function(a){a?e.util.eachProp(this.ifaces,function(b,c){return b===a?(this.teardown(c),this.emit(this.emitChannel,{type:"close",to:c}),!0):void 0}.bind(this)):this.close()}.bind(this),a.onClose=function(a,b){return"function"==typeof a&&void 0===b?void this.once("close",a):void e.util.eachProp(this.ifaces,function(c,d){return c===a?(this.handlers[d]?this.handlers[d].push(b):this.handlers[d]=[b],!0):void 0}.bind(this))}.bind(this),a},e.port.Provider.prototype.getProvider=function(a,b){if(!this.providerCls)return e.debug.warn("Cannot instantiate provider, since it is not provided"),null;var c,d,f,g={};return e.util.eachProp(this.definition,function(a,b){"event"===a.type&&(g[b]=a)}),c=function(a,b,c,d){if(a[c]){var f=e.proxy.messageToPortable(a[c].value,d);this.emit(this.emitChannel,{type:"message",to:b,message:{name:c,type:"event",text:f.text,binary:f.binary}})}}.bind(this,g,a),d=this.providerCls.bind.apply(this.providerCls,[this.providerCls,c].concat(b||[])),f=new d,function(a,b){if("method"===b.action){if("function"!=typeof this[b.type])return void e.debug.warn("Provider does not implement "+b.type+"()!");var c=a.definition[b.type],d=e.proxy.portableToMessage(c.value,b),g=function(a,b,c,d){var f=e.proxy.messageToPortable(b.ret,c);this.emit(this.emitChannel,{type:"method",to:a.to,message:{to:a.to,type:"method",reqId:a.reqId,name:a.type,text:f.text,binary:f.binary,error:d}})}.bind(a,b,c);if(Array.isArray(d)||(d=[d]),a.mode===e.port.Provider.mode.synchronous)try{g(this[b.type].apply(this,d))}catch(h){g(void 0,h.message)}else a.mode===e.port.Provider.mode.asynchronous?this[b.type].apply(f,d.concat(g)):a.mode===e.port.Provider.mode.promises&&this[b.type].apply(this,d).then(g,g.bind({},void 0))}}.bind(f,this)},e.port.Provider.prototype.toString=function(){return this.emitChannel?"[Provider "+this.emitChannel+"]":"[unbound Provider]"},"undefined"==typeof e&&(e={}),e.port=e.port||{},e.port.Proxy=function(a){this.id=e.port.Proxy.nextId(),this.interfaceCls=a,e.util.handleEvents(this),this.ifaces={},this.closeHandlers={},this.errorHandlers={},this.emits={}
},e.port.Proxy.prototype.onMessage=function(a,b){if("control"===a&&b.reverse)this.emitChannel=b.channel,this.emit(this.emitChannel,{type:"channel announcement",channel:b.reverse}),this.emit("start");else if("control"===a&&"setup"===b.type)this.controlChannel=b.channel;else if("control"===a&&"close"===b.type)delete this.controlChannel,this.doClose();else{if(!this.emitChannel&&b.channel)return this.emitChannel=b.channel,void this.emit("start");if("close"===b.type&&b.to)return void this.teardown(b.to);if("error"===b.type)return void this.error(b.to,b.message);if(b.to)this.emits[b.to]?this.emits[b.to]("message",b.message):e.debug.warn("Could not deliver message, no such interface: "+b.to);else{{b.message}e.util.eachProp(this.emits,function(a){a("message",b.message)})}}},e.port.Proxy.prototype.getInterface=function(){var a=this.getInterfaceConstructor(),b=Array.prototype.slice.call(arguments,0);return new(a=a.bind.apply(a,[a].concat(b)))},e.port.Proxy.prototype.getProxyInterface=function(){var a=function(a){var b=Array.prototype.slice.call(arguments,1);return a.getInterface(b)}.bind({},this);return a.close=function(a){a?e.util.eachProp(this.ifaces,function(b,c){return b===a?(this.teardown(c),this.emit(this.emitChannel,{type:"close",to:c}),!0):void 0}.bind(this)):this.doClose()}.bind(this),a.onClose=function(a,b){return"function"==typeof a&&void 0===b?void this.once("close",a):void e.util.eachProp(this.ifaces,function(c,d){return c===a?(this.closeHandlers[d]?this.closeHandlers[d].push(b):this.closeHandlers[d]=[b],!0):void 0}.bind(this))}.bind(this),a.onError=function(a,b){return"function"==typeof a&&void 0===b?void this.on("error",a):void e.util.eachProp(this.ifaces,function(c,d){return c===a?(this.errorHandlers[d]?this.errorHandlers[d].push(b):this.errorHandlers[d]=[b],!0):void 0}.bind(this))}.bind(this),a},e.port.Proxy.prototype.getInterfaceConstructor=function(){var a=e.port.Proxy.nextId();return this.interfaceCls.bind({},function(a,b,c){this.ifaces[a]=b,this.emits[a]=c}.bind(this,a),this.doEmit.bind(this,a))},e.port.Proxy.prototype.doEmit=function(a,b,c){c&&(a=!1),this.emitChannel?this.emit(this.emitChannel,{to:a,type:"message",message:b}):this.once("start",this.doEmit.bind(this,a,b))},e.port.Proxy.prototype.teardown=function(a){delete this.emits[a],this.closeHandlers[a]&&e.util.eachProp(this.closeHandlers[a],function(a){a()}),delete this.ifaces[a],delete this.closeHandlers[a],delete this.errorHandlers[a]},e.port.Proxy.prototype.error=function(a,b){a&&this.errorHandlers[a]?e.util.eachProp(this.errorHandlers[a],function(a){a(b)}):a||this.emit("error",b)},e.port.Proxy.prototype.doClose=function(){this.controlChannel&&this.emit(this.controlChannel,{type:"Channel Closing",request:"close"}),e.util.eachProp(this.emits,function(a,b){this.teardown(b)}.bind(this)),this.emit("close"),this.off(),this.emitChannel=null},e.port.Proxy.prototype.toString=function(){return this.emitChannel?"[Proxy "+this.emitChannel+"]":"[unbound Proxy]"},e.port.Proxy.nextId=function(){return e.port.Proxy.id||(e.port.Proxy.id=1),e.port.Proxy.id+=1},"undefined"==typeof e&&(e={}),e.port=e.port||{},e.port.Runtime=function(){this.id="runtime",this.config={},this.runtimes={},this.core=null,this.socket=null,this.status=e.port.Runtime.status.disconnected,e.util.handleEvents(this)},e.port.Runtime.status={disconnected:0,connecting:1,connected:2},e.port.Runtime.prototype.toString=function(){return"[Port to Priviledged Runtime]"},e.port.Runtime.prototype.onMessage=function(a,b){if("control"===a&&"setup"===b.type){var c={};e.util.mixin(c,b.config),delete c.global,delete c.src,b.config=c,this.controlChannel=b.channel,this.connect(),this.emit(this.controlChannel,{type:"Get Core Provider",request:"core"})}else"control"!==a||"core"!==b.type||this.core||(this.core=b.core);this.status===e.port.Runtime.status.connected?this.socket.send(JSON.stringify([a,b])):this.once("connected",this.onMessage.bind(this,a,b))},e.port.Runtime.prototype.connect=function(){var a=this.config.runtimeHost||"127.0.0.1",b=this.config.runtimePort||9009;this.socket||this.status!==e.port.Runtime.status.disconnected||(e.debug.log("FreeDOM Runtime Link connecting"),this.status=e.port.Runtime.status.connecting,this.socket=new WebSocket("ws://"+a+":"+b),this.socket.addEventListener("open",function(){e.debug.log("FreeDOM Runtime Link connected"),this.status=e.port.Runtime.status.connected,this.emit("connected"),e.apis.register("core.runtime",this.runtime.bind(this,this))}.bind(this),!0),this.socket.addEventListener("message",this.message.bind(this),!0),this.socket.addEventListener("close",function(){e.debug.log("FreeDOM Runtime Link disconnected"),this.status=e.port.Runtime.status.disconnected}.bind(this),!0))},e.port.Runtime.prototype.message=function(a){try{var b=JSON.parse(a.data);if("runtime"===b[0]&&"load"===b[1].request)return void e.resources.getContents(b[1].url).then(function(a,b,c){this.onMessage("runtime",{response:"load",file:a,from:b,data:c})}.bind(this,b[1].url,b[1].from));"runtime"===b[0]&&"message"===b[1].request&&(this.runtimes[b[1].id]||e.debug.warn("Asked to relay to non-existant runtime:"+b[1].id),this.runtimes[b[1].id].channel.emit(b[1].data[0],b[1].data[1])),this.emit(b[0],b[1])}catch(c){e.debug.warn(c.stack),e.debug.warn("Unable to parse runtime message: "+a)}},e.port.Runtime.prototype.runtime=function(a,b){this.id=Math.random(),this.link=a,this.app=b,this.link.runtimes[this.id]=this},e.port.Runtime.prototype.runtime.prototype.createApp=function(a,b){e.resources.get(this.app.manifestId,a).then(function(a){this.link.onMessage("runtime",{request:"createApp",from:this.app.manifestId,to:a,id:this.id}),this.link.core.bindChannel(b).then(function(a){a.on(function(a,b){return this.link.onMessage("runtime",{request:"message",id:this.id,data:[a,b]}),!1}.bind(this)),this.channel=a}.bind(this))}.bind(this))},"undefined"==typeof e&&(e={});var i=function(){this.files={},this.resolvers=[this.httpResolver,this.nullResolver],this.contentRetreivers={http:this.xhrRetriever,https:this.xhrRetriever,"chrome-extension":this.xhrRetriever,resource:this.xhrRetriever,chrome:this.xhrRetriever,manifest:this.manifestRetriever}};i.prototype.get=function(a,b){var c=JSON.stringify([a,b]);return new Promise(function(d,e){this.files[c]?d(this.files[c]):this.resolve(a,b).then(function(a,b,c){this.files[a]=c,b(c)}.bind(this,c,d),e)}.bind(this))},i.prototype.getContents=function(a){return new Promise(function(b,c){var d;if(!a)return e.debug.warn("Asked to get contents of undefined URL."),c();for(d in this.contentRetreivers)if(this.contentRetreivers.hasOwnProperty(d)&&0===a.indexOf(d+"://"))return this.contentRetreivers[d](a,b,c);c()}.bind(this))},i.prototype.resolve=function(a,b){return new Promise(function(c,d){var f=[];return void 0===b?d():(e.util.eachReverse(this.resolvers,function(c){f.push(new Promise(c.bind({},a,b)))}.bind(this)),void Promise.race(f).then(c,d))}.bind(this))},i.prototype.addResolver=function(a){this.resolvers.push(a)},i.prototype.addRetriever=function(a,b){return this.contentRetreivers[a]?void e.debug.warn("Unwilling to override file retrieval for "+a):void(this.contentRetreivers[a]=b)},i.prototype.httpResolver=function(a,b,c){var d,e,f,g,h,i,j=["http","https","chrome","chrome-extension","resource"];for(e=0;e<j.length;e+=1)if(0===b.indexOf(j[e]+"://"))return c(b),!0;if(!a)return!1;for(e=0;e<j.length;e+=1)if(0===a.indexOf(j[e]+"://")&&-1===b.indexOf("://"))return d=a.substr(0,a.lastIndexOf("/")),f=d.indexOf("://"),g=f+3+d.substr(f+3).indexOf("/"),h=d.substr(g),i=d.substr(0,g),c(0===b.indexOf("/")?i+b:i+h+"/"+b),!0;return!1},i.prototype.nullResolver=function(a,b,c){var d,e=["manifest","data;base64"];for(d=0;d<e.length;d+=1)if(0===b.indexOf(e[d]+"://"))return c(b),!0;return!1},i.prototype.manifestRetriever=function(a,b,c){var d;try{d=a.substr(11),JSON.parse(d),b(d)}catch(e){console.warn("Invalid manifest URL referenced:"+a),c()}},i.prototype.xhrRetriever=function(a,b,c){var d=new XMLHttpRequest;d.addEventListener("readystatechange",function(b,c){4===d.readyState&&d.responseText?b(d.responseText):4===d.readyState&&(console.warn("Failed to load file "+a+": "+d.status),c(d.status))}.bind({},b,c),!1),d.overrideMimeType("application/json"),d.open("GET",a,!0),d.send()},e.resources=new i,"undefined"==typeof e&&(e={}),e.util={},e.util.eachReverse=function(a,b){if(a){var c;for(c=a.length-1;c>-1&&(!a[c]||!b(a[c],c,a));c-=1);}},e.util.hasProp=function(a,b){return Object.prototype.hasOwnProperty.call(a,b)},e.util.eachProp=function(a,b){var c;for(c in a)if(a.hasOwnProperty(c)&&b(a[c],c))break},e.util.mixin=function(a,b,c){return b&&e.util.eachProp(b,function(b,d){(c||!e.util.hasProp(a,d))&&(a[d]=b)}),a},e.util.getId=function(){var a,b="guid",c=12;if("object"==typeof crypto)a=new Uint8Array(c),crypto.getRandomValues(a),e.util.eachReverse(a,function(a){b+="-"+a});else for(;c>0;)b+="-"+Math.ceil(255*Math.random()),c-=1;return b},e.util.handleEvents=function(a){var b,c,d={multiple:{},maybemultiple:[],single:{},maybesingle:[]};b=function(a,b){var c,d=[];if(!a||!a.length)return[];for(c=a.length-1;c>=0;c-=1)b(a[c])&&d.push(a.splice(c,1));return d},c=function(a,b,c){"function"==typeof b?this["maybe"+a].push([b,c]):this[a][b]?this[a][b].push(c):this[a][b]=[c]},a.on=c.bind(d,"multiple"),a.once=c.bind(d,"single"),a.emit=function(a,b){var c,d;if(this.multiple[a])for(c=0;c<this.multiple[a].length;c+=1)if(this.multiple[a][c](b)===!1)return;if(this.single[a])for(d=this.single[a],this.single[a]=[],c=0;c<d.length;c+=1)d[c](b);for(c=0;c<this.maybemultiple.length;c+=1)this.maybemultiple[c][0](a,b)&&this.maybemultiple[c][1](b);for(c=this.maybesingle.length-1;c>=0;c-=1)this.maybesingle[c][0](a,b)&&(d=this.maybesingle.splice(c,1),d[0][1](b))}.bind(d),a.off=function(a,c){return a?("function"==typeof a&&(b(this.maybesingle,function(b){return b[0]===a&&(!c||b[1]===c)}),b(this.maybemultiple,function(b){return b[0]===a&&(!c||b[1]===c)})),void(c?(b(this.multiple[a],function(a){return a===c}),b(this.single[a],function(a){return a===c})):(delete this.multiple[a],delete this.single[a]))):(this.multiple={},this.maybemultiple=[],this.single={},void(this.maybesingle=[]))}.bind(d)},e.util.isAppContext=function(){return"undefined"==typeof document},e.util.forceAppContext=function(a){var b,c,d=e.util.isAppContext.name+"=function()",f=" { return true; }",g=a.indexOf(d);return-1===g?void e.debug.warn("Unable to force App Context, source is in unexpected condition."):(b=a.substr(0,g+d.length)+f+"|| function()"+a.substr(g+d.length),c=e.util.getBlob(b,"text/javascript"),e.util.getURL(c))},e.util.getBlob=function(a,b){if("function"!=typeof Blob&&"undefined"!=typeof WebKitBlobBuilder){var c=new WebKitBlobBuilder;return c.append(a),c.getBlob(b)}return new Blob([a],{type:b})},e.util.getURL=function(a){return"object"!=typeof URL&&"undefined"!=typeof webkitURL?webkitURL.createObjectURL(a):URL.createObjectURL(a)},e.util.advertise=function(a){"undefined"!=typeof location?"chrome-extension:"!==location.protocol&&"chrome:"!==location.protocol&&"resource:"!==location.protocol&&!a||"undefined"==typeof freedomcfg||freedomcfg(e.apis.register.bind(e.apis)):a&&"undefined"!=typeof freedomcfg&&freedomcfg(e.apis.register.bind(e.apis))},e.util.scripts=function(global){return global.document.getElementsByTagName("script")},"undefined"==typeof e&&(e={}),e.link=e.link||{},e.link.Direct=function(){e.Link.call(this)},e.link.Direct.prototype.start=function(){if(this.config.appContext)this.config.global.directLink.other=this,this.other=this.config.global.directLink,this.other.emit("started");else{this.config.global.directLink=this;var a=e.debug,b=e.setup(this.config.global,void 0,{isApp:!0,portType:"Direct"});e.debug=a,this.config.global.freedom=b}},e.link.Direct.prototype.stop=function(){this===this.config.global.directLink&&delete this.config.global.directLink,delete this.other},e.link.Direct.prototype.toString=function(){return"[Direct"+this.id+"]"},e.link.Direct.prototype.deliverMessage=function(a,b){this.other?("control"===a&&(a=this.other.controlChannel),setTimeout(this.other.emit.bind(this.other,a,b),0)):this.once("started",this.onMessage.bind(this,a,b))},"undefined"==typeof e&&(e={}),e.link=e.link||{},e.link.Frame=function(){e.Link.call(this)},e.link.Frame.prototype.start=function(){this.config.appContext?(this.config.global.DEBUG=!0,this.setupListener(),this.src="in"):(this.setupFrame(),this.src="out")},e.link.Frame.prototype.stop=function(){},e.link.Frame.prototype.toString=function(){return"[Frame"+this.id+"]"},e.link.Frame.prototype.setupListener=function(){var a=function(a){"in"!==a.data.src&&this.emitMessage(a.data.flow,a.data.message)}.bind(this);this.obj=this.config.global,this.obj.addEventListener("message",a,!0),this.stop=function(){this.obj.removeEventListener("message",a,!0),delete this.obj},this.emit("started")},e.link.Frame.prototype.setupFrame=function(){var a,b;a=this.makeFrame(this.config.src,this.config.inject),document.body||document.appendChild(document.createElement("body")),document.body.appendChild(a),b=function(a,b){this.obj||(this.obj=a,this.emit("started")),"out"!==b.data.src&&this.emitMessage(b.data.flow,b.data.message)}.bind(this,a.contentWindow),a.contentWindow.addEventListener("message",b,!0),this.stop=function(){a.contentWindow.removeEventListener("message",b,!0),this.obj&&delete this.obj,a.src="about:blank",document.body.removeChild(a)}},e.link.Frame.prototype.makeFrame=function(a,b){var c,d,f=document.createElement("iframe"),g="";return a=a.replace("'portType': 'Worker'","'portType': 'Frame'"),b&&(g='<script src="'+b+'" onerror="throw new Error(\'Injection of '+b+" Failed!');\"></script>"),c="<html>"+g+'<script src="'+e.util.forceAppContext(a)+'"></script></html>',d=e.util.getBlob(c,"text/html"),f.src=e.util.getURL(d),f},e.link.Frame.prototype.deliverMessage=function(a,b){this.obj?this.obj.postMessage({src:this.src,flow:a,message:b},"*"):this.once("started",this.onMessage.bind(this,a,b))},"undefined"==typeof e&&(e={}),e.link=e.link||{},e.link.Worker=function(a){a&&(this.manifest=a.substr(a.lastIndexOf("/")+1)),e.Link.call(this)},e.link.Worker.prototype.start=function(){this.config.appContext?this.setupListener():this.setupWorker()},e.link.Worker.prototype.stop=function(){},e.link.Worker.prototype.toString=function(){return"[Worker"+this.id+"]"},e.link.Worker.prototype.setupListener=function(){var a=function(a){this.emitMessage(a.data.flow,a.data.message)}.bind(this);this.obj=this.config.global,this.obj.addEventListener("message",a,!0),this.stop=function(){this.obj.removeEventListener("message",a,!0),delete this.obj},this.emit("started")},e.link.Worker.prototype.setupWorker=function(){var a,b;typeof g.Blob!=typeof Function?a=new Worker(this.config.source):(b=new g.Blob([this.config.src],{type:"text/javascript"}),a=new Worker(g.URL.createObjectURL(b)+"#"+this.manifest)),a.addEventListener("error",function(a){e.debug.error(a,this.toString())},!0),a.addEventListener("message",function(a,b){this.obj||(this.obj=a,this.emit("started")),this.emitMessage(b.data.flow,b.data.message)}.bind(this,a),!0),this.stop=function(){a.stop(),this.obj&&delete this.obj}},e.link.Worker.prototype.deliverMessage=function(a,b){"control"===a&&"close"===b.type&&"control"===b.channel?this.stop():this.obj?this.obj.postMessage({flow:a,message:b}):this.once("started",this.onMessage.bind(this,a,b))},"undefined"==typeof e&&(e={}),e.proxy=e.proxy||{},e.proxy.ApiInterface=function(a,b,c){var d={},f=null,g=null,h=0,i=arguments;e.util.eachProp(a,function(a,b){switch(a.type){case"method":this[b]=function(){var f=h,g=new Promise(function(b,c){d[f]={resolve:b,reject:c,template:a.ret}}),i=e.proxy.messageToPortable(a.value,arguments);return h+=1,c({action:"method",type:b,reqId:f,text:i.text,binary:i.binary}),g};break;case"event":f||(e.util.handleEvents(this),g=this.emit,delete this.emit,f={}),f[b]=a;break;case"constant":Object.defineProperty(this,b,{value:e.proxy.recursiveFreezeObject(a.value),writable:!1})}}.bind(this)),b(this,function(a,b){if("close"===a)return this.off(),void delete this.inflight;if(b)if("method"===b.type)if(d[b.reqId]){var c=d[b.reqId],h=c.template;delete d[b.reqId],b.error?c.reject(b.error):c.resolve(e.proxy.portableToMessage(h,b))}else e.debug.warn("Dropped response message with id "+b.reqId);else"event"===b.type&&f[b.name]&&g(b.name,e.proxy.portableToMessage(f[b.name].value,b))}.bind(this)),i=e.proxy.messageToPortable(a.constructor?a.constructor.value:[],Array.prototype.slice.call(i,3)),c({type:"construct",text:i.text,binary:i.binary})},e.proxy.messageToPortable=function(a,b){var c=[],d=e.proxy.conform(a,b,c,!0);return{text:d,binary:c}},e.proxy.portableToMessage=function(a,b){return e.proxy.conform(a,b.text,b.binary,!1)},e.proxy.conform=function(a,b,c,d){if("function"==typeof b)return void 0;if("undefined"==typeof b||void 0===a)return void 0;if(null===b)return null;switch(a){case"string":return String("")+b;case"number":return Number(1)*b;case"boolean":return Boolean(b===!0);case"object":return"undefined"==typeof b?void 0:JSON.parse(JSON.stringify(b));case"blob":return d?b instanceof Blob?(c.push(b),c.length-1):(e.debug.warn("conform expecting Blob, sees "+typeof b),c.push(new Blob([])),c.length-1):c[b];case"buffer":return d?(c.push(e.proxy.makeArrayBuffer(b)),c.length-1):e.proxy.makeArrayBuffer(c[b]);case"proxy":return b}var f,g;if(Array.isArray(a)&&void 0!==b){if(f=[],g=0,2===a.length&&"array"===a[0])for(g=0;g<b.length;g+=1)f.push(e.proxy.conform(a[1],b[g],c,d));else for(g=0;g<a.length;g+=1)f.push(void 0!==b[g]?e.proxy.conform(a[g],b[g],c,d):void 0);return f}return"object"==typeof a&&void 0!==b?(f={},e.util.eachProp(a,function(a,g){void 0!==b[g]&&(f[g]=e.proxy.conform(a,b[g],c,d))}),f):void e.debug.warn("Unknown template type: "+a)},e.proxy.makeArrayBuffer=function(a){return a?a instanceof ArrayBuffer?a:"ArrayBuffer"===a.constructor.name&&"undefined"==typeof a.prototype?new DataView(a).buffer:(e.debug.warn("expecting ArrayBuffer, but saw "+typeof a+": "+JSON.stringify(a)),new ArrayBuffer(0)):new ArrayBuffer(0)},e.proxy.recursiveFreezeObject=function(a){var b,c={};if("object"!=typeof a)return a;for(b in a)a.hasOwnProperty(b)&&Object.defineProperty(c,b,{value:e.proxy.recursiveFreezeObject(a[b]),writable:!1,enumerable:!0});return c},"undefined"==typeof e&&(e={}),e.proxy=e.proxy||{},e.proxy.EventInterface=function(a,b){e.util.handleEvents(this),a(this,function(a,b,c){a(c.type,c.message)}.bind(this,this.emit)),this.emit=function(a,b,c){a({type:b,message:c},!0)}.bind({},b)},e.apis.set("core",{createChannel:{type:"method",value:[],ret:{channel:"proxy",identifier:"string"}},bindChannel:{type:"method",value:["string"],ret:"proxy"},getId:{type:"method",value:[],ret:["array","string"]}}),e.apis.set("core.view",{open:{type:"method",value:["string",{file:"string",code:"string"}]},show:{type:"method",value:[]},close:{type:"method",value:[]},postMessage:{type:"method",value:["object"]},message:{type:"event",value:"object"},onClose:{type:"event",value:[]}}),e.apis.set("core.storage",{keys:{type:"method",value:[],ret:["array","string"]},get:{type:"method",value:["string"],ret:"string"},set:{type:"method",value:["string","string"],ret:"string"},remove:{type:"method",value:["string"],ret:"string"},clear:{type:"method",value:[]}}),e.apis.set("core.tcpsocket",{constructor:{value:["number"]},getInfo:{type:"method",value:[],ret:{connected:"boolean",localAddress:"string",localPort:"number",peerAddress:"string",peerPort:"number"}},close:{type:"method",value:[],err:{errcode:"string",message:"string"}},onDisconnect:{type:"event",value:{errcode:"string",message:"string"}},connect:{type:"method",value:["string","number"],err:{errcode:"string",message:"string"}},write:{type:"method",value:["buffer"],err:{errcode:"string",message:"string"}},onData:{type:"event",value:{data:"buffer"}},listen:{type:"method",value:["string","number"],err:{errcode:"string",message:"string"}},onConnection:{type:"event",value:{socket:"number",host:"string",port:"number"}}}),e.apis.set("core.udpsocket",{bind:{type:"method",value:["string","number"],ret:"number"},getInfo:{type:"method",value:[],ret:{localAddress:"string",localPort:"number"}},sendTo:{type:"method",value:["buffer","string","number"],ret:"number"},destroy:{type:"method",value:[]},onData:{type:"event",value:{resultCode:"number",address:"string",port:"number",data:"buffer"}}}),e.apis.set("core.runtime",{createApp:{type:"method",value:["string","proxy"]},resolve:{type:"method",value:["string","string"]},needFile:{type:"event",value:["string","string"]}}),e.apis.set("core.echo",{setup:{type:"method",value:["string"]},send:{type:"method",value:["string"]},message:{type:"event",value:"string"}}),e.apis.set("core.peerconnection",{setup:{type:"method",value:["string","string",["array","string"]]},send:{type:"method",value:[{channelLabel:"string",text:"string",binary:"blob",buffer:"buffer"}]},onReceived:{type:"event",value:{channelLabel:"string",text:"string",binary:"blob",buffer:"buffer"}},openDataChannel:{type:"method",value:["string"]},closeDataChannel:{type:"method",value:["string"]},onOpenDataChannel:{type:"event",value:{channelId:"string"}},onCloseDataChannel:{type:"event",value:{channelId:"string"}},getBufferedAmount:{type:"method",value:["string"],ret:"number"},close:{type:"method",value:[]},onClose:{type:"event",value:{}}}),e.apis.set("core.websocket",{constructor:{value:["string",["array","string"]]},send:{type:"method",value:[{text:"string",binary:"blob",buffer:"buffer"}],err:{errcode:"string",message:"string"}},getReadyState:{type:"method",value:[],ret:"number"},getBufferedAmount:{type:"method",value:["string"],ret:"number"},close:{type:"method",value:["number","string"],err:{errcode:"string",message:"string"}},onMessage:{type:"event",value:{text:"string",binary:"blob",buffer:"buffer"}},onOpen:{type:"event",value:[]},onError:{type:"event",value:[{errcode:"string",message:"string"}]},onClose:{type:"event",value:[{code:"number",reason:"string",wasClean:"boolean"}]}}),e.apis.set("social",{ERRCODE:{type:"constant",value:{SUCCESS:"Success!",UNKNOWN:"Unknown error",OFFLINE:"User is currently offline",LOGIN_BADCREDENTIALS:"Error authenticating with server",LOGIN_FAILEDCONNECTION:"Error connecting to server",LOGIN_ALREADYONLINE:"User is already logged in",SEND_INVALIDDESTINATION:"Message sent to an invalid destination"}},STATUS:{type:"constant",value:{OFFLINE:"OFFLINE",ONLINE:"ONLINE",ONLINE_WITH_OTHER_APP:"ONLINE_WITH_OTHER_APP"}},login:{type:"method",value:[{agent:"string",version:"string",url:"string",interactive:"boolean",rememberLogin:"boolean"}],ret:{userId:"string",clientId:"string",status:"string",timestamp:"number"},err:{errcode:"string",message:"string"}},clearCachedCredentials:{type:"method",value:[]},getClients:{type:"method",value:[],ret:"object",err:{errcode:"string",message:"string"}},getUsers:{type:"method",value:[],ret:"object",err:{errcode:"string",message:"string"}},sendMessage:{type:"method",value:["string","string"],err:{errcode:"string",message:"string"}},logout:{type:"method",value:[],err:{errcode:"string",message:"string"}},onMessage:{type:"event",value:{from:{userId:"string",clientId:"string",status:"string",timestamp:"number"},message:"string"}},onUserProfile:{type:"event",value:{userId:"string",timestamp:"number",name:"string",url:"string",imageData:"string"}},onClientState:{type:"event",value:{userId:"string",clientId:"string",status:"string",timestamp:"number"}}}),e.apis.set("storage",{scope:{type:"constant",value:{SESSION:0,DEVICE_LOCAL:1,USER_LOCAL:2,SHARED:3}},constructor:{value:[{scope:"number"}]},keys:{type:"method",value:[],ret:["array","string"]},get:{type:"method",value:["string"],ret:"string"},set:{type:"method",value:["string","string"],ret:"string"},remove:{type:"method",value:["string"],ret:"string"},clear:{type:"method",value:[]}}),e.apis.set("transport",{setup:{type:"method",value:["string","proxy"]},send:{type:"method",value:["string","buffer"]},close:{type:"method",value:[]},onData:{type:"event",value:{tag:"string",data:"buffer"}},onClose:{type:"event",value:[]}});var j=function(a){this.manager=a};j.unboundChannels={},j.contextId=void 0,j.prototype.createChannel=function(a){var b=new e.port.Proxy(e.proxy.EventInterface),c=e.util.getId(),d=this.getChannel(b);this.manager.setup(b),this.manager.delegate&&this.manager.toDelegate.core&&this.manager.emit(this.manager.delegate,{type:"Delegation",request:"handle",flow:"core",message:{type:"register",id:c}}),j.unboundChannels[c]={local:!0,proxy:b},b.once("start",this.getChannel.bind(this,b)),a({channel:d,identifier:c})},j.prototype.getChannel=function(a){var b=a.getProxyInterface(),c=b();return c.close=b.close,c.onClose=b.onClose,b.onClose(c,function(){a.doClose()}),c},j.prototype.onMessage=function(a,b){"register"===b.type?j.unboundChannels[b.id]={remote:!0,resolve:b.reply,source:a}:"clear"===b.type?delete j.unboundChannels[b.id]:"bind"===b.type&&j.unboundChannels[b.id]&&this.bindChannel(b.id,function(){},a)},j.prototype.bindChannel=function(a,b,c){var d=j.unboundChannels[a],f=!c;if(f&&(e.debug.log("making local proxy for core binding"),c=new e.port.Proxy(e.proxy.EventInterface),this.manager.setup(c)),d&&d.local)e.debug.log("doing local binding with "+c),this.manager.createLink(c,a,d.proxy,"default"),delete j.unboundChannels[a],this.manager.delegate&&this.manager.toDelegate.core&&this.manager.emit(this.manager.delegate,{type:"Delegation",request:"handle",flow:"core",message:{type:"clear",id:a}});else{if(!d||!d.remote)return this.manager.delegate&&this.manager.toDelegate.core?(e.debug.warn("delegating bind request for unseen ID:"+a),this.manager.emit(this.manager.delegate,{type:"Delegation",request:"handle",flow:"core",message:{type:"bind",id:a}}),c.once("start",function(a,b){b(this.getChannel(a))}.bind(this,c,b)),this.manager.createLink(c,"default",this.manager.hub.getDestination(this.manager.delegate),a),void delete j.unboundChannels[a]):(e.debug.warn("Asked to bind unknown channel: "+a),e.debug.log(j.unboundChannels),void b());e.debug.log("doing remote binding downward"),this.manager.createLink(c,f?"default":a,d.source,a),d.resolve({type:"Bind Channel",request:"core",flow:"core",message:{type:"bind",id:a}}),delete j.unboundChannels[a]}c.getInterface?b(this.getChannel(c)):b()},j.prototype.getId=function(a){a(j.contextId)},j.prototype.setId=function(a){j.contextId=a},e.apis.register("core",j);var k=function(a,b){e.debug.log("Echo Created!"),this.mod=a,this.dispatchEvent=b,e.util.handleEvents(this),this.mod.once("core",function(a){this.core=new a}.bind(this)),this.mod.emit(this.mod.controlChannel,{type:"core request delegated to echo",request:"core"})};k.prototype.setup=function(a,b){return b(),this.core?void this.core.bindChannel(a,function(a){this.chan&&this.chan.close(),this.chan=a,this.chan.onClose(function(){delete this.chan}.bind(this)),this.dispatchEvent("message","channel bound to echo"),this.chan.on("message",function(a){this.dispatchEvent("message","from custom channel: "+a)}.bind(this))}.bind(this)):void this.dispatchEvent("message","no core available to setup proxy with at echo")},k.prototype.send=function(a,b){b(),this.chan?this.chan.emit("message",a):this.dispatchEvent("message","no channel available")},e.apis.register("core.echo",k);var l={DISCONNECTED:"DISCONNECTED",CONNECTING:"CONNECTING",CONNECTED:"CONNECTED"};b.prototype.runWhenReady=function(a){"undefined"==typeof this.pc||null===this.pc?console.error("SimpleDataPeer: Something is terribly wrong. PeerConnection is null"):a()},b.prototype.send=function(a,b,c){this.channels[a].send(b),c()},b.prototype.openDataChannel=function(a,b){this.runWhenReady(function(){var c=this.pc.createDataChannel(a,{});c.onopen=function(){this.addDataChannel(a,c),b()}.bind(this),c.onerror=function(a){console.error(a),b(void 0,a)}}.bind(this))},b.prototype.closeChannel=function(a){void 0!==this.channels[a]&&(this.channels[a].close(),delete this.channels[a])},b.prototype.getBufferedAmount=function(a){if(void 0!==this.channels[a]){var b=this.channels[a];return b.bufferedAmount}throw new Error("No channel with id: "+a)},b.prototype.setSendSignalMessage=function(a){this.sendSignalMessage=a},b.prototype.handleSignalMessage=function(a){var b=JSON.parse(a);this.runWhenReady(function(){if(b.sdp)this.pc.setRemoteDescription(new this.RTCSessionDescription(b.sdp),function(){"offer"===this.pc.remoteDescription.type&&this.pc.createAnswer(this.onDescription.bind(this))}.bind(this),function(a){console.error(this.peerName+": setRemoteDescription failed:",a)}.bind(this));else if(b.candidate){var c=new RTCIceCandidate(b.candidate);this.pc.addIceCandidate(c)}else console.warn(this.peerName+": handleSignalMessage got unexpected message: ",a)}.bind(this))},b.prototype.negotiateConnection=function(){this.pcState=l.CONNECTING,this.runWhenReady(function(){this.pc.createOffer(this.onDescription.bind(this),function(a){console.error(this.peerName+": createOffer failed: ",a.toString()),this.pcState=l.DISCONNECTED}.bind(this))}.bind(this))},b.prototype.close=function(){"closed"!==this.pc.signalingState&&this.pc.close()},b.prototype.addDataChannel=function(a,b){var c=this.dataChannelCallbacks;this.channels[a]=b,"connecting"===b.readyState&&(b.onopen=c.onOpenFn.bind(this,b,{label:a})),b.onclose=c.onCloseFn.bind(this,b,{label:a}),b.onmessage=c.onMessageFn.bind(this,b,{label:a}),b.onerror=c.onErrorFn.bind(this,b,{label:b})},b.prototype.onDescription=function(a){this.runWhenReady(function(){this.sendSignalMessage?this.pc.setLocalDescription(a,function(){this.sendSignalMessage(JSON.stringify({sdp:a}))}.bind(this),function(a){console.error(this.peerName+": setLocalDescription failed:",a)}.bind(this)):console.error(this.peerName+": _onDescription: _sendSignalMessage is not set, so we did not set the local description. ")}.bind(this))},b.prototype.onNegotiationNeeded=function(){if(this.pcState!==l.DISCONNECTED){var a=function(){return function(){}.bind(this)}.bind(this),b=function(){return function(){}.bind(this)}.bind(this);return void(this.pc.localDescription&&this.pc.remoteDescription&&"offer"===this.pc.localDescription.type?(this.pc.setLocalDescription(this.pc.localDescription,a("setLocalDescription"),b("setLocalDescription")),this.pc.setRemoteDescription(this.pc.remoteDescription,a("setRemoteDescription"),b("setRemoteDescription"))):this.pc.localDescription&&this.pc.remoteDescription&&"answer"===this.pc.localDescription.type&&(this.pc.setRemoteDescription(this.pc.remoteDescription,a("setRemoteDescription"),b("setRemoteDescription")),this.pc.setLocalDescription(this.pc.localDescription,a("setLocalDescription"),b("setLocalDescription"))))}this.negotiateConnection()},b.prototype.onIceCallback=function(a){a.candidate&&(this.sendSignalMessage?this.sendSignalMessage(JSON.stringify({candidate:a.candidate})):console.warn(this.peerName+": _onDescription: _sendSignalMessage is not set."))},b.prototype.onSignalingStateChange=function(){"stable"===this.pc.signalingState&&(this.pcState=l.CONNECTED)},b.prototype.onDataChannel=function(a){this.addDataChannel(a.channel.label,a.channel),this.dataChannelCallbacks.onOpenFn(a.channel,{label:a.channel.label})},c.prototype.setup=function(a,c,d,e){this.peerName=c;var f={RTCPeerConnection:this.RTCPeerConnection,RTCSessionDescription:this.RTCSessionDescription},g=this,h={onOpenFn:function(a,b){g.dispatchEvent("onOpenDataChannel",b.label)},onCloseFn:function(a,b){g.dispatchEvent("onCloseDataChannel",{channelId:b.label})},onMessageFn:function(a,b,c){c.data instanceof ArrayBuffer?g.dispatchEvent("onReceived",{channelLabel:b.label,buffer:c.data}):"string"==typeof c.data&&g.dispatchEvent("onReceived",{channelLabel:b.label,text:c.data})},onErrorFn:function(a,b,c){console.error(a.peerName+": dataChannel("+a.dataChannel.label+"): error: ",c)}};this.peer=new b(this.peerName,d,h,f),this.core.bindChannel(a,function(a){this.signallingChannel=a,this.peer.setSendSignalMessage(function(a){this.signallingChannel.emit("message",a)}.bind(this)),this.signallingChannel.on("message",this.peer.handleSignalMessage.bind(this.peer)),this.signallingChannel.emit("ready"),e()
}.bind(this))},c.prototype.openDataChannel=function(a,b){this.peer.openDataChannel(a,b)},c.prototype.closeDataChannel=function(a,b){this.peer.closeChannel(a),b()},c.prototype.send=function(a,b){var c=a.text||a.buffer||a.binary;return"undefined"==typeof c?void console.error("No valid data to send has been provided.",a):void this.peer.send(a.channelLabel,c,b)},c.prototype.getBufferedAmount=function(a,b){b(this.peer.getBufferedAmount(a))},c.prototype.close=function(a){this.peer.close(),a(),this.dispatchEvent("onClose")},e.apis.register("core.peerconnection",c);var m=function(a){this.app=a,e.util.handleEvents(this)};m.prototype.keys=function(a){var b,c=[];for(b=0;b<localStorage.length;b+=1)c.push(localStorage.key(b));a(c)},m.prototype.get=function(a,b){try{var c=localStorage.getItem(a);b(c)}catch(d){b(null)}},m.prototype.set=function(a,b,c){localStorage.setItem(a,b),c()},m.prototype.remove=function(a,b){localStorage.removeItem(a),b()},m.prototype.clear=function(a){localStorage.clear(),a()},e.apis.register("core.storage",m);var n=function(a,b){this.dispatchEvent=b,this.host=null,this.win=null,this.app=a,e.util.handleEvents(this)};n.prototype.open=function(a,b,c){this.host=document.createElement("div"),this.host.style.width="100%",this.host.style.height="100%",this.host.style.display="relative";var d,f,g=document.body,h=this.app.manifest.views;h&&h[a]&&document.getElementById(a)&&(g=document.getElementById(a)),g.appendChild(this.host),d=this.host,f=document.createElement("iframe"),f.setAttribute("sandbox","allow-scripts allow-forms"),b.file?e.resources.get(this.app.manifestId,b.file).then(function(a){this.finishOpen(d,f,a,c)}.bind(this)):b.code?this.finishOpen(d,f,"data:text/html;charset=utf-8,"+b.code,c):c(!1)},n.prototype.finishOpen=function(a,b,c,d){b.src=c,b.style.width="100%",b.style.height="100%",b.style.border="0",b.style.background="transparent",a.appendChild(b),this.app.config.global.addEventListener("message",this.onMessage.bind(this),!0),this.win=b,d({})},n.prototype.show=function(a){a()},n.prototype.postMessage=function(a,b){this.win.contentWindow.postMessage(a,"*"),b()},n.prototype.close=function(a){this.host&&(this.host.parentNode.removeChild(this.host),this.host=null),this.win&&(this.app.config.global.removeEventListener("message",this.onMessage.bind(this),!0),this.win=null),a()},n.prototype.onMessage=function(a){a.source===this.win.contentWindow&&this.dispatchEvent("message",a.data)},e.apis.register("core.view",n),d.prototype.send=function(a,b){var c,d,e=a.text||a.binary||a.buffer;if(e)try{this.websocket.send(e)}catch(f){c=f instanceof SyntaxError?"SYNTAX":"INVALID_STATE",d=f.message}else c="BAD_SEND",d="No text, binary, or buffer data found.";c?b(void 0,{errcode:c,message:d}):b()},d.prototype.getReadyState=function(a){a(this.websocket.readyState)},d.prototype.getBufferedAmount=function(a){a(this.websocket.bufferedAmount)},d.prototype.close=function(a,b,c){try{a&&b?this.websocket.close(a,b):this.websocket.close(),c()}catch(d){var e;e=d instanceof SyntaxError?"SYNTAX":"INVALID_ACCESS",c(void 0,{errcode:e,message:d.message})}},d.prototype.onOpen=function(){this.dispatchEvent("onOpen")},d.prototype.onMessage=function(a){var b={text:void 0,binary:void 0,buffer:void 0};a.data instanceof ArrayBuffer?b.buffer=b:a.data instanceof Blob?b.binary=b:"string"==typeof a.data&&(b.text=a.data),this.dispatchEvent("onMessage",b)},d.prototype.onError=function(){this.dispatchEvent("onError")},d.prototype.onClose=function(a){this.dispatchEvent("onClose",{code:a.code,reason:a.reason,wasClean:a.wasClean})},e.apis.register("core.websocket",d),global.freedom=e.setup(global,f)}}()}(this);