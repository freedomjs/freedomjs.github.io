/**
 * This is freedom.js. - https://freedomjs.org
 *
 * Copyright 2013 The freedom.js authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * @license apache2.0
 * @see https://freedomjs.org
 */
!function(global){"use strict";!function a(){function b(a,b,c,d){var e,f,g;if(this.peerName=a,this.channels={},this.dataChannelCallbacks=c,this.onConnectedQueue=[],"undefined"!=typeof d.RTCPeerConnection)this.RTCPeerConnection=d.RTCPeerConnection;else if("undefined"!=typeof webkitRTCPeerConnection)this.RTCPeerConnection=webkitRTCPeerConnection;else{if("undefined"==typeof mozRTCPeerConnection)throw new Error("This environment does not appear to support RTCPeerConnection");this.RTCPeerConnection=mozRTCPeerConnection}if("undefined"!=typeof d.RTCSessionDescription)this.RTCSessionDescription=d.RTCSessionDescription;else if("undefined"!=typeof RTCSessionDescription)this.RTCSessionDescription=RTCSessionDescription;else{if("undefined"==typeof mozRTCSessionDescription)throw new Error("This environment does not appear to support RTCSessionDescription");this.RTCSessionDescription=mozRTCSessionDescription}if("undefined"!=typeof d.RTCIceCandidate)this.RTCIceCandidate=d.RTCIceCandidate;else if("undefined"!=typeof RTCIceCandidate)this.RTCIceCandidate=RTCIceCandidate;else{if("undefined"==typeof mozRTCIceCandidate)throw new Error("This environment does not appear to support RTCIceCandidate");this.RTCIceCandidate=mozRTCIceCandidate}for(e={optional:[{DtlsSrtpKeyAgreement:!0}]},this.sendSignalMessage=null,this.pc=null,f={iceServers:[]},g=0;g<b.length;g+=1)f.iceServers.push({url:b[g]});this.pc=new this.RTCPeerConnection(f,e),this.pc.addEventListener("icecandidate",this.onIceCallback.bind(this)),this.pc.addEventListener("negotiationneeded",this.onNegotiationNeeded.bind(this)),this.pc.addEventListener("datachannel",this.onDataChannel.bind(this)),this.pc.addEventListener("signalingstatechange",function(){"stable"===this.pc.signalingState&&(this.pcState=k.CONNECTED,this.onConnectedQueue.map(function(a){a()}))}.bind(this)),this.pcState=k.DISCONNECTED}function c(a,b,c,d,e){this.dispatchEvent=b,this.peerName="p"+Math.random(),this.freedomModule=a,this.RTCPeerConnection=c,this.RTCSessionDescription=d,this.RTCIceCandidate=e,this.signallingChannel=null,this.peer=null,this.freedomModule.once("core",function(a){this.core=new a}.bind(this)),this.freedomModule.emit(this.freedomModule.controlChannel,{type:"core request delegated to peerconnection",request:"core"})}var d,e="(function (global) {'use strict';("+a+")();})(this);";if("undefined"==typeof global.freedom){if("undefined"==typeof f)var f=global;!function(){var a,b,c,d;!function(){var e={},f={};a=function(a,b,c){e[a]={deps:b,callback:c}},d=c=b=function(a){function c(b){if("."!==b.charAt(0))return b;for(var c=b.split("/"),d=a.split("/").slice(0,-1),e=0,f=c.length;f>e;e++){var g=c[e];if(".."===g)d.pop();else{if("."===g)continue;d.push(g)}}return d.join("/")}if(d._eak_seen=e,f[a])return f[a];if(f[a]={},!e[a])throw new Error("Could not find module "+a);for(var g,h=e[a],i=h.deps,j=h.callback,k=[],l=0,m=i.length;m>l;l++)k.push("exports"===i[l]?g={}:b(c(i[l])));var n=j.apply(this,k);return f[a]=g||n}}(),a("promise/all",["./utils","exports"],function(a,b){function c(a){var b=this;if(!d(a))throw new TypeError("You must pass an array to all.");return new b(function(b,c){function d(a){return function(b){f(a,b)}}function f(a,c){h[a]=c,0===--i&&b(h)}var g,h=[],i=a.length;0===i&&b([]);for(var j=0;j<a.length;j++)g=a[j],g&&e(g.then)?g.then(d(j),c):f(j,g)})}var d=a.isArray,e=a.isFunction;b.all=c}),a("promise/asap",["exports"],function(a){function b(){return function(){process.nextTick(e)}}function c(){var a=0,b=new j(e),c=document.createTextNode("");return b.observe(c,{characterData:!0}),function(){c.data=a=++a%2}}function d(){return function(){k.setTimeout(e,1)}}function e(){for(var a=0;a<l.length;a++){var b=l[a],c=b[0],d=b[1];c(d)}l=[]}function g(a,b){var c=l.push([a,b]);1===c&&h()}var h,i="undefined"!=typeof f?f:{},j=i.MutationObserver||i.WebKitMutationObserver,k="undefined"!=typeof global?global:void 0===this?f:this,l=[];h="undefined"!=typeof process&&"[object process]"==={}.toString.call(process)?b():j?c():d(),a.asap=g}),a("promise/config",["exports"],function(a){function b(a,b){return 2!==arguments.length?c[a]:void(c[a]=b)}var c={instrument:!1};a.config=c,a.configure=b}),a("promise/polyfill",["./promise","./utils","exports"],function(a,b,c){function d(){var a;a="undefined"!=typeof global?global:"undefined"!=typeof f&&f.document?f:self;var b="Promise"in a&&"resolve"in a.Promise&&"reject"in a.Promise&&"all"in a.Promise&&"race"in a.Promise&&function(){var b;return new a.Promise(function(a){b=a}),g(b)}();b||(a.Promise=e)}var e=a.Promise,g=b.isFunction;c.polyfill=d}),a("promise/promise",["./config","./utils","./all","./race","./resolve","./reject","./asap","exports"],function(a,b,c,d,e,f,g,h){function i(a){if(!v(a))throw new TypeError("You must pass a resolver function as the first argument to the promise constructor");if(!(this instanceof i))throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.");this._subscribers=[],j(a,this)}function j(a,b){function c(a){o(b,a)}function d(a){q(b,a)}try{a(c,d)}catch(e){d(e)}}function k(a,b,c,d){var e,f,g,h,i=v(c);if(i)try{e=c(d),g=!0}catch(j){h=!0,f=j}else e=d,g=!0;n(b,e)||(i&&g?o(b,e):h?q(b,f):a===D?o(b,e):a===E&&q(b,e))}function l(a,b,c,d){var e=a._subscribers,f=e.length;e[f]=b,e[f+D]=c,e[f+E]=d}function m(a,b){for(var c,d,e=a._subscribers,f=a._detail,g=0;g<e.length;g+=3)c=e[g],d=e[g+b],k(b,c,d,f);a._subscribers=null}function n(a,b){var c,d=null;try{if(a===b)throw new TypeError("A promises callback cannot return that same promise.");if(u(b)&&(d=b.then,v(d)))return d.call(b,function(d){return c?!0:(c=!0,void(b!==d?o(a,d):p(a,d)))},function(b){return c?!0:(c=!0,void q(a,b))}),!0}catch(e){return c?!0:(q(a,e),!0)}return!1}function o(a,b){a===b?p(a,b):n(a,b)||p(a,b)}function p(a,b){a._state===B&&(a._state=C,a._detail=b,t.async(r,a))}function q(a,b){a._state===B&&(a._state=C,a._detail=b,t.async(s,a))}function r(a){m(a,a._state=D)}function s(a){m(a,a._state=E)}var t=a.config,u=(a.configure,b.objectOrFunction),v=b.isFunction,w=(b.now,c.all),x=d.race,y=e.resolve,z=f.reject,A=g.asap;t.async=A;var B=void 0,C=0,D=1,E=2;i.prototype={constructor:i,_state:void 0,_detail:void 0,_subscribers:void 0,then:function(a,b){var c=this,d=new this.constructor(function(){});if(this._state){var e=arguments;t.async(function(){k(c._state,d,e[c._state-1],c._detail)})}else l(this,d,a,b);return d},"catch":function(a){return this.then(null,a)}},i.all=w,i.race=x,i.resolve=y,i.reject=z,h.Promise=i}),a("promise/race",["./utils","exports"],function(a,b){function c(a){var b=this;if(!d(a))throw new TypeError("You must pass an array to race.");return new b(function(b,c){for(var d,e=0;e<a.length;e++)d=a[e],d&&"function"==typeof d.then?d.then(b,c):b(d)})}var d=a.isArray;b.race=c}),a("promise/reject",["exports"],function(a){function b(a){var b=this;return new b(function(b,c){c(a)})}a.reject=b}),a("promise/resolve",["exports"],function(a){function b(a){if(a&&"object"==typeof a&&a.constructor===this)return a;var b=this;return new b(function(b){b(a)})}a.resolve=b}),a("promise/utils",["exports"],function(a){function b(a){return c(a)||"object"==typeof a&&null!==a}function c(a){return"function"==typeof a}function d(a){return"[object Array]"===Object.prototype.toString.call(a)}var e=Date.now||function(){return(new Date).getTime()};a.objectOrFunction=b,a.isFunction=c,a.isArray=d,a.now=e}),b("promise/polyfill").polyfill()}(),"undefined"==typeof d&&(d={});var g=function(){this.apis={},this.providers={},this.waiters={}};g.prototype.get=function(a){return this.apis[a]?{name:a,definition:this.apis[a]}:!1},g.prototype.set=function(a,b){this.apis[a]=b},g.prototype.register=function(a,b){var c;if(this.providers[a]=b,this.waiters[a]){for(c=0;c<this.waiters[a].length;c+=1)this.waiters[a][c][0](b.bind({},this.waiters[a][c][2]));delete this.waiters[a]}},g.prototype.getCore=function(a,b){return new Promise(function(c,e){this.apis[a]?this.providers[a]?c(this.providers[a].bind({},b)):(this.waiters[a]||(this.waiters[a]=[]),this.waiters[a].push([c,e,b])):(d.debug.warn("Api.getCore asked for unknown core: "+a),e(null))}.bind(this))},d.apis=new g,"undefined"==typeof d&&(d={}),d.setup=function(global,a,b){d.debug=new d.port.Debug;var c,e=new d.Hub,f={debug:!0,stayLocal:!1,portType:"Worker",moduleContext:b&&"undefined"!=typeof b.isModule?b.isModule:d.util.isModuleContext()},g=new d.port.Manager(e),h=new d.port.Proxy(d.proxy.EventInterface);return g.setup(h),f.moduleContext?(b&&d.util.mixin(f,b,!0),f.global=global,f.src=a,c=new d.link[f.portType],g.setup(c),g.createLink(h,"default",c),g.once("delegate",g.setup.bind(g,d.debug))):(g.setup(d.debug),d.util.advertise(b?b.advertise:void 0),"undefined"!=typeof document&&d.util.eachReverse(d.util.scripts(global),function(a){var b=a.getAttribute("data-manifest"),c=a.src;if(b){if(f.source=c,f.manifest=b,a.textContent.trim().length)try{d.util.mixin(f,JSON.parse(a.textContent),!0)}catch(e){d.debug.warn("Failed to parse configuration: "+e)}return!0}}),f.global=global,f.src=a,f.resources=d.resources,b&&d.util.mixin(f,b,!0),"undefined"!=typeof location&&(f.location=location.protocol+"//"+location.host+location.pathname),f.policy=new d.Policy(g,f),d.resources.get(f.location,f.manifest).then(function(a){f.policy.get([],a).then(g.createLink.bind(g,h,"default"))},function(a){d.debug.error("Failed to retrieve manifest: "+a)})),e.emit("config",f),"undefined"==typeof global.console&&(global.console=d.debug),h.getInterface()},"undefined"==typeof d&&(d={}),d.Hub=function(){this.route=Math.round(1e6*Math.random()),this.config={},this.apps={},this.routes={},this.unbound=[],d.util.handleEvents(this),this.on("config",function(a){d.util.mixin(this.config,a)}.bind(this))},d.Hub.prototype.onMessage=function(a,b){var c,e=this.routes[a];return e&&e.app?this.apps[e.app]?(b.quiet||(c=b.type,"message"===b.type&&b.message&&"method"===b.message.action?c="method."+b.message.type:"method"===b.type&&b.message&&"method"===b.message.type?c="return."+b.message.name:"message"===b.type&&b.message&&"event"===b.message.type&&(c="event."+b.message.name),d.debug.log(this.apps[e.source].toString()+" -"+c+"-> "+this.apps[e.app].toString()+"."+e.flow)),void this.apps[e.app].onMessage(e.flow,b)):void d.debug.warn("Message dropped to destination "+e.app):void d.debug.warn("Message dropped from unregistered source "+a)},d.Hub.prototype.getDestination=function(a){var b=this.routes[a];return b?this.apps[b.app]:null},d.Hub.prototype.getSource=function(a){return a?this.apps[a.id]?this.apps[a.id]:(d.debug.warn("No registered source '"+a.id+"'"),!1):!1},d.Hub.prototype.register=function(a,b){return!this.apps[a.id]||b?(this.apps[a.id]=a,!0):!1},d.Hub.prototype.deregister=function(a){return this.apps[a.id]?(delete this.apps[a.id],!0):!1},d.Hub.prototype.install=function(a,b,c){if(a=this.getSource(a)){if(!b)return void d.debug.warn("Unwilling to generate blackhole flow from "+a.id);var e=this.generateRoute();return this.routes[e]={app:b,flow:c,source:a.id},"function"==typeof a.on&&a.on(e,this.onMessage.bind(this,e)),e}},d.Hub.prototype.uninstall=function(a,b){if(a=this.getSource(a)){var c=this.routes[b];return c?c.source!==a.id?(d.debug.warn("Flow "+b+" does not belong to port "+a.id),!1):(delete this.routes[b],"function"==typeof a.off&&a.off(c),!0):!1}},d.Hub.prototype.generateRoute=function(){return this.route+=1},"undefined"==typeof d&&(d={}),d.Link=function(){this.id="Link"+Math.random(),this.config={},this.src=null,d.util.handleEvents(this),d.util.mixin(this,d.Link.prototype)},d.Link.prototype.onMessage=function(a,b){"control"!==a||this.controlChannel?this.deliverMessage(a,b):!this.controlChannel&&b.channel&&(this.controlChannel=b.channel,d.util.mixin(this.config,b.config),this.start())},d.Link.prototype.emitMessage=function(a,b){"control"===a&&this.controlChannel&&(a=this.controlChannel),this.emit(a,b)},"undefined"==typeof d&&(d={}),d.Policy=function(a,b){this.location=b.location,this.config=b,this.runtimes=[],this.policies=[],this.add(a,b.policy),this.runtimes[0].local=!0},d.Policy.prototype.defaultPolicy={background:!1,interactive:!0},d.Policy.prototype.defaultConstraints={isolation:"always",placement:"local"},d.Policy.prototype.get=function(a,b){return this.loadManifest(b).then(function(c){var e,f=this.overlay(this.defaultConstraints,c.constraints),g=this.findDestination(a,b,f);return g.local?(e=this.isRunning(g,b,a,"never"!==f.isolation),"always"!==f.isolation&&e?(d.debug.log("Reused port "+e),g.manager.getPort(e)):new d.port.Module(b,c,a)):(d.debug.error("Unexpected location selected for module placement"),!1)}.bind(this),function(a){return d.debug.error("Policy Error Resolving "+b,a),!1})},d.Policy.prototype.findDestination=function(a,b,c){var d;if("always"!==c.isolation)for(d=0;d<this.policies.length;d+=1)if(this.isRunning(this.runtimes[d],b,a,"never"!==c.isolation))return this.runtimes[d];if("local"===c.placement)return this.runtimes[0];if("stable"===c.placement)for(d=0;d<this.policies.length;d+=1)if(this.policies[d].background)return this.runtimes[d];return this.runtimes[0]},d.Policy.prototype.isRunning=function(a,b,c,d){var e,f=0,g=0;for(f=0;f<a.modules.length;f+=1)if(d&&a.modules[f].length===c.length+1){for(e=!0,g=0;g<c.length;g+=1)if(0!==a.modules[f][g+1].indexOf(c[g])){e=!1;break}if(0!==a.modules[f][0].indexOf(b)&&(e=!1),e)return a.modules[f][0]}else if(!d&&0===a.modules[f][0].indexOf(b))return a.modules[f][0];return!1},d.Policy.prototype.loadManifest=function(a){return d.resources.getContents(a).then(function(a){try{return JSON.parse(a)}catch(b){return d.debug.warn("Failed to load "+this.manifestId+": "+b),{}}})},d.Policy.prototype.add=function(a,b){var c={manager:a,modules:[]};this.runtimes.push(c),this.policies.push(this.overlay(this.defaultPolicy,b)),a.on("moduleAdd",function(a,b){var c=b.lineage;c[0]=b.id,a.modules.push(c)}.bind(this,c)),a.on("moduleRemove",function(a,b){var c,e,f=b.lineage;for(f[0]=b.id,e=f.toString(),c=0;c<a.modules.length;c+=1)if(a.modules[c].toString()===e)return void a.modules.splice(c,1);d.debug.warn("Unknown module to remove: ",b.id)}.bind(this,c))},d.Policy.prototype.overlay=function(a,b){var c={};return d.util.mixin(c,a),b&&d.util.mixin(c,b,!0),c},"undefined"==typeof d&&(d={}),d.port=d.port||{},d.port.Debug=function(){this.id="debug",this.emitChannel=!1,this.console=null,this.config=!1,d.util.handleEvents(this)},d.port.Debug.prototype.toString=function(){return"[Console]"},d.port.Debug.prototype.onMessage=function(a,b){"control"===a&&b.channel&&!this.emitChannel&&(this.emitChannel=b.channel,this.config=b.config.debug,this.console=b.config.global.console,this.emit("ready"))},d.port.Debug.prototype.format=function(a,b,c){var d,e=[];if("string"==typeof c)e.push(c);else for(d=0;d<c.length;d+=1)e.push(c[d]);return this.emitChannel?void this.emit(this.emitChannel,{severity:a,source:b,quiet:!0,request:"debug",msg:JSON.stringify(e)}):void this.on("ready",this.format.bind(this,a,b,e))},d.port.Debug.prototype.print=function(a){var b,c=Boolean(this.config),d=[],e=0;if("string"==typeof this.config)for(c=!1,b=this.config.split(" "),e=0;e<b.length;e+=1)if(0===b[e].indexOf("source:")){if(void 0===a.source||a.source.indexOf(b[e].substr(7))>-1){c=!0;break}}else if(a.msg.indexOf(b[e])>-1){c=!0;break}if(c&&"undefined"!=typeof this.console&&this.console!==this){if(b=JSON.parse(a.msg),"string"==typeof b)d.push(b);else for(;void 0!==b[e];)d.push(b[e]),e+=1;"undefined"!=typeof process&&a.source?(d.unshift("[39m"),d.unshift("[31m"+a.source)):this.console.__mozillaConsole__&&a.source?d.unshift(a.source.toUpperCase()):a.source&&(d.unshift("color: red"),d.unshift("%c "+a.source)),!this.console[a.severity]&&this.console.log&&(a.severity="log"),this.console[a.severity].apply(this.console,d)}},d.port.Debug.prototype.log=function(){this.format("log",void 0,arguments)},d.port.Debug.prototype.warn=function(){this.format("warn",void 0,arguments)},d.port.Debug.prototype.error=function(){this.format("error",void 0,arguments),this.console&&this.console.error.apply(this.console,arguments)},"undefined"==typeof d&&(d={}),d.port=d.port||{},d.port.Manager=function(a){this.id="control",this.config={},this.controlFlows={},this.dataFlows={},this.dataFlows[this.id]=[],this.reverseFlowMap={},this.hub=a,this.delegate=null,this.toDelegate={},this.hub.on("config",function(a){d.util.mixin(this.config,a),this.emit("config")}.bind(this)),d.util.handleEvents(this),this.hub.register(this)},d.port.Manager.prototype.toString=function(){return"[Local Controller]"},d.port.Manager.prototype.onMessage=function(a,b){var c,e=this.controlFlows[a];if(!e)return void d.debug.warn("Unknown message source: "+a);if(c=this.hub.getDestination(e),this.delegate&&e!==this.delegate&&this.toDelegate[a])return void this.emit(this.delegate,{type:"Delegation",request:"handle",quiet:!0,flow:a,message:b});if("debug"===b.request)return void(this.config.debug&&d.debug.print(b));if("link"===b.request)this.createLink(c,b.name,b.to,b.overrideDest);else if("port"===b.request)b.exposeManager&&(b.args=this),this.createLink(c,b.name,new d.port[b.service](b.args));else if("bindport"===b.request)this.createLink({id:b.id},"custom"+b.port,new d.port[b.service](b.args),"default",!0);else if("delegate"===b.request)null===this.delegate&&(this.delegate=e),this.toDelegate[b.flow]=!0,this.emit("delegate");else if("resource"===b.request)d.resources.addResolver(b.args[0]),d.resources.addRetriever(b.service,b.args[1]);else if("core"===b.request){if(this.core&&e===this.delegate)return void(new this.core).onMessage(c,b.message);this.getCore(function(a,b){this.hub.onMessage(a,{type:"core",core:b})}.bind(this,e))}else if("close"===b.request)this.destroy(c);else{if("unlink"!==b.request)return d.debug.warn("Unknown control request: "+b.request),void d.debug.log(JSON.stringify(b));this.removeLink(c,b.to)}},d.port.Manager.prototype.getPort=function(a){return this.hub.getDestination(this.controlFlows[a])},d.port.Manager.prototype.setup=function(a){if(!a.id)return d.debug.warn("Refusing to setup unidentified port "),!1;if(this.controlFlows[a.id])return d.debug.warn("Refusing to re-initialize port "+a.id),!1;if(!this.config.global)return void this.once("config",this.setup.bind(this,a));this.hub.register(a);var b=this.hub.install(this,a.id,"control"),c=this.hub.install(a,this.id,a.id);return this.controlFlows[a.id]=b,this.dataFlows[a.id]=[c],this.reverseFlowMap[b]=c,this.reverseFlowMap[c]=b,a.lineage&&this.emit("moduleAdd",{id:a.id,lineage:a.lineage}),this.hub.onMessage(b,{type:"setup",channel:c,config:this.config}),!0},d.port.Manager.prototype.destroy=function(a){if(!a.id)return d.debug.warn("Unable to tear down unidentified port"),!1;a.lineage&&this.emit("moduleRemove",{id:a.id,lineage:a.lineage}),delete this.controlFlows[a.id];var b;for(b=this.dataFlows[a.id].length-1;b>=0;b-=1)this.removeLink(a,this.dataFlows[a.id][b]);delete this.dataFlows[a.id],this.hub.deregister(a)},d.port.Manager.prototype.createLink=function(a,b,c,e,f){if(!this.config.global)return void this.once("config",this.createLink.bind(this,a,b,c,e));if(!this.controlFlows[a.id])return void d.debug.warn("Unwilling to link from non-registered source.");if(!this.controlFlows[c.id]&&this.setup(c)===!1)return void d.debug.warn("Could not find or setup destination.");var g,h=e||"default",i=this.hub.install(a,c.id,h);c=this.hub.getDestination(i),g=this.hub.install(c,a.id,b),this.reverseFlowMap[i]=g,this.dataFlows[a.id].push(i),this.reverseFlowMap[g]=i,this.dataFlows[c.id].push(g),f?this.hub.onMessage(this.controlFlows[c.id],{type:"createLink",name:h,channel:g,reverse:i}):this.hub.onMessage(this.controlFlows[a.id],{name:b,type:"createLink",channel:i,reverse:g})},d.port.Manager.prototype.removeLink=function(a,b){var c,e=this.hub.getDestination(b),f=this.reverseFlowMap[b];return e&&f?this.hub.getDestination(f).id!==a.id?void d.debug.warn("Source port does not own flow "+b):(c=this.controlFlows[a.id],c&&this.hub.onMessage(c,{type:"close",channel:b}),c=this.controlFlows[e.id],c&&this.hub.onMessage(c,{type:"close",channel:f}),this.hub.uninstall(a,b),this.hub.uninstall(e,f),delete this.reverseFlowMap[b],delete this.reverseFlowMap[f],this.forgetFlow(e.id,f),void this.forgetFlow(a.id,b)):void d.debug.warn("Could not find metadata to remove flow: "+b)},d.port.Manager.prototype.forgetFlow=function(a,b){var c;if(this.dataFlows[a])for(c=0;c<this.dataFlows[a].length;c+=1)if(this.dataFlows[a][c]===b){this.dataFlows[a].splice(c,1);break}},d.port.Manager.prototype.getCore=function(a){this.core?a(this.core):d.apis.getCore("core",this).then(function(b){this.core=b,a(this.core)}.bind(this))},"undefined"==typeof d&&(d={}),d.port=d.port||{},d.port.Module=function(a,b,c){this.config={},this.id=a+Math.random(),this.manifestId=a,this.manifest=b,this.lineage=[this.manifestId].concat(c),this.externalPortMap={},this.internalPortMap={},this.started=!1,d.util.handleEvents(this)},d.port.Module.prototype.onMessage=function(a,b){if("control"===a){if("setup"===b.type)return this.controlChannel=b.channel,d.util.mixin(this.config,b.config),this.emit(this.controlChannel,{type:"Core Provider",request:"core"}),void this.start();if("createLink"===b.type&&b.channel)return this.externalPortMap[b.name]=b.channel,void 0===this.internalPortMap[b.name]&&(this.internalPortMap[b.name]=!1),void this.emit(b.channel,{type:"default channel announcement",channel:b.reverse});if(b.core)return this.core=new b.core,void this.emit("core",b.core);"close"===b.type?("control"===b.channel&&this.stop(),this.deregisterFlow(b.channel,!1)):this.port.onMessage(a,b)}else{if((this.externalPortMap[a]===!1||!this.externalPortMap[a])&&b.channel)return this.externalPortMap[a]=b.channel,void(void 0===this.internalPortMap[a]&&(this.internalPortMap[a]=!1,this.manifest.provides&&this.modInternal?this.port.onMessage(this.modInternal,{type:"Connection",channel:a}):this.manifest.provides?this.once("modInternal",function(a){this.port.onMessage(this.modInternal,{type:"Connection",channel:a})}.bind(this,a)):!this.externalPortMap["default"]&&b.channel&&(this.externalPortMap["default"]=b.channel,this.once("internalChannelReady",function(a){this.internalPortMap[a]=this.internalPortMap["default"]}.bind(this,a)))));if(this.started)if(this.internalPortMap[a]===!1)this.once("internalChannelReady",this.onMessage.bind(this,a,b));else{if(!this.internalPortMap[a])return void d.debug.error("Unexpected message from "+a);this.port.onMessage(this.internalPortMap[a],b)}else this.once("start",this.onMessage.bind(this,a,b))}},d.port.Module.prototype.deregisterFlow=function(a,b){var c,d=b?this.internalPortMap:this.externalPortMap;for(c in d)if(d[c]===a)return b?this.emit(this.controlChannel,{type:"Channel Teardown",request:"unlink",to:this.externalPortMap[c]}):this.port.onMessage("control",{type:"close",channel:this.internalPortMap[c]}),delete this.externalPortMap[c],delete this.internalPortMap[c],!0;return!1},d.port.Module.prototype.start=function(){return this.started||this.port?!1:void(this.controlChannel&&(this.loadLinks(),this.port=new d.link[this.config.portType](this.manifestId),this.port.on(this.emitMessage.bind(this)),this.port.onMessage("control",{channel:"control",config:this.config}),this.port.onMessage("control",{type:"Redirect",request:"delegate",flow:"debug"}),this.port.onMessage("control",{type:"Redirect",request:"delegate",flow:"core"}),this.port.onMessage("control",{type:"Environment Configuration",request:"port",name:"ModInternal",service:"ModuleInternal",exposeManager:!0})))},d.port.Module.prototype.stop=function(){this.started&&(this.port&&(this.port.off(),this.port.onMessage("control",{type:"close",channel:"control"}),delete this.port),this.started=!1)},d.port.Module.prototype.toString=function(){return"[Module "+this.manifest.name+"]"},d.port.Module.prototype.emitMessage=function(a,b){if(this.internalPortMap[a]===!1&&b.channel)return this.internalPortMap[a]=b.channel,void this.emit("internalChannelReady");if("control"===a)if("debug"===b.flow&&b.message)d.debug.format(b.message.severity,this.toString(),b.message.msg);else if("core"===b.flow&&b.message){if(!this.core)return void this.once("core",this.emitMessage.bind(this,a,b));"register"===b.message.type&&(b.message.reply=this.port.onMessage.bind(this.port,"control"),this.externalPortMap[b.message.id]=!1),this.core.onMessage(this,b.message)}else"ModInternal"!==b.name||this.modInternal?"createLink"===b.type?(this.manifest.provides&&0===this.manifest.provides.indexOf(b.name)&&(this.internalPortMap["default"]=b.channel),this.internalPortMap[b.name]=b.channel,this.port.onMessage(b.channel,{type:"channel announcement",channel:b.reverse}),this.emit("internalChannelReady")):"close"===b.type&&this.deregisterFlow(b.channel,!0):(this.modInternal=b.channel,this.port.onMessage(this.modInternal,{type:"Initialization",id:this.manifestId,appId:this.id,manifest:this.manifest,lineage:this.lineage,channel:b.reverse}),this.emit("modInternal"));else"ModInternal"!==a||"ready"!==b.type||this.started?"ModInternal"===a&&"resolve"===b.type?d.resources.get(this.manifestId,b.data).then(function(a,b){this.port.onMessage(this.modInternal,{type:"resolve response",id:a,data:b})}.bind(this,b.id),function(){d.debug.warn("Error Resolving URL for Module.")}):this.emit(this.externalPortMap[a],b):(this.started=!0,this.emit("start"));return!1},d.port.Module.prototype.loadLinks=function(){var a,b,c,e=["default"],f=function(a,b){a.getInterface().provideAsynchronous(b)};if(this.manifest.permissions)for(a=0;a<this.manifest.permissions.length;a+=1)b=this.manifest.permissions[a],e.indexOf(b)<0&&0===b.indexOf("core.")&&(e.push(b),c=new d.port.Provider(d.apis.get(b).definition),d.apis.getCore(b,this).then(f.bind(this,c)),this.emit(this.controlChannel,{type:"Core Link to "+b,request:"link",name:b,to:c}));for(this.manifest.dependencies&&d.util.eachProp(this.manifest.dependencies,function(a,b){e.indexOf(b)<0&&e.push(b),d.resources.get(this.manifestId,a.url).then(function(a){this.config.policy.get(this.lineage,a).then(function(a){this.emit(this.controlChannel,{type:"Link to "+b,request:"link",name:b,overrideDest:b+"."+this.id,to:a})}.bind(this)),d.resources.getContents(a).then(this.updateEnv.bind(this,b))}.bind(this))}.bind(this)),a=0;a<e.length;a+=1)this.externalPortMap[e[a]]=this.externalPortMap[e[a]]||!1,this.internalPortMap[e[a]]=!1},d.port.Module.prototype.updateEnv=function(a,b){if(b){this.modInternal||this.once("modInternal",this.updateEnv.bind(this,a,b));var c={name:b.name,icon:b.icon,description:b.description};this.port.onMessage(this.modInternal,{type:"manifest",name:a,manifest:c})}},d.port.Module.prototype.serialize=function(){return JSON.serialize({manifestId:this.manifestId,externalPortMap:this.externalPortMap,internalPortMap:this.internalPortMap,manifest:this.manifest,controlChannel:this.controlChannel})},"undefined"==typeof d&&(d={}),d.port=d.port||{},d.port.ModuleInternal=function(a){this.config={},this.manager=a,this.manifests={},this.id="ModuleInternal-"+Math.random(),this.pendingPorts=0,this.requests={},this.defaultProvider=null,d.util.handleEvents(this)},d.port.ModuleInternal.prototype.onMessage=function(a,b){if("control"===a)!this.controlChannel&&b.channel&&(this.controlChannel=b.channel,d.util.mixin(this.config,b.config));else if("default"!==a||this.appId)"default"===a&&this.requests[b.id]?(this.requests[b.id](b.data),delete this.requests[b.id]):"default"===a&&"manifest"===b.type?this.updateManifest(b.name,b.manifest):"default"===a&&"Connection"===b.type&&this.defaultProvider&&this.manager.createLink(this.defaultProvider,b.channel,this.port,b.channel);else{this.port=this.manager.hub.getDestination(b.channel),this.externalChannel=b.channel,this.appId=b.appId,this.lineage=b.lineage;var c=this.mapProxies(b.manifest);this.updateEnv(b.manifest),this.once("start",this.loadScripts.bind(this,b.id,b.manifest.app.script)),this.loadLinks(c)}},d.port.ModuleInternal.prototype.toString=function(){return"[Module Environment Helper]"},d.port.ModuleInternal.prototype.updateEnv=function(a){var b=this.config.global.freedom,c={name:a.name,icon:a.icon,description:a.description};b&&(b.manifest=c)},d.port.ModuleInternal.prototype.attach=function(a,b,c){var d=this.config.global.freedom;d[a]||(d[a]=b.getProxyInterface(),c&&(d[a].api=c),this.manifests[a]&&(d[a].manifest=this.manifests[a])),this.pendingPorts-=1,0===this.pendingPorts&&this.emit("start")},d.port.ModuleInternal.prototype.loadLinks=function(a){var b,c,e,f,g;for(b=0;b<a.length;b+=1)g=void 0,a[b].def?(g=a[b].def.name,a[b].provides?(c=new d.port.Provider(a[b].def.definition),this.defaultProvider||(this.defaultProvider=c)):c=new d.port.Proxy(d.proxy.ApiInterface.bind({},a[b].def.definition))):c=new d.port.Proxy(d.proxy.EventInterface),c.once("start",this.attach.bind(this,a[b].name,c,g)),this.manager.createLink(this.port,a[b].name,c),this.pendingPorts+=1;d.resources.addResolver(function(a,b,c){var d=Math.random();return this.requests[d]=c,this.emit(this.externalChannel,{type:"resolve",id:d,data:b}),!0}.bind(this)),this.pendingPorts+=1,f=d.apis.get("core").definition,e=new d.port.Provider(f),this.manager.getCore(function(a){new a(this.manager).setId(this.lineage),e.getInterface().provideAsynchronous(a)}.bind(this)),this.emit(this.controlChannel,{type:"Link to core",request:"link",name:"core",to:e}),c=new d.port.Proxy(d.proxy.ApiInterface.bind({},f)),this.manager.createLink(e,"default",c),this.attach("core",c),0===this.pendingPorts&&this.emit("start")},d.port.ModuleInternal.prototype.updateManifest=function(a,b){var c=this.config.global.freedom;c[a]?c[a].manifest=b:this.manifests[a]=b},d.port.ModuleInternal.prototype.mapProxies=function(a){var b,c,e=[],f=["core"];if(a.permissions)for(b=0;b<a.permissions.length;b+=1)c={name:a.permissions[b],def:void 0},c.def=d.apis.get(c.name),f.indexOf(c.name)<0&&c.def&&(e.push(c),f.push(c.name));if(a.dependencies&&d.util.eachProp(a.dependencies,function(a,b){c={name:b},f.indexOf(b)<0&&(a.api&&(c.def=d.apis.get(a.api)),e.push(c),f.push(b))}),a.provides)for(b=0;b<a.provides.length;b+=1)c={name:a.provides[b],def:void 0,provides:!0},c.def=d.apis.get(c.name),f.indexOf(c.name)<0&&c.def&&(e.push(c),f.push(c.name));return e},d.port.ModuleInternal.prototype.loadScripts=function(a,b){var c=0,e=!0,f=function(a,b){this.config.global.importScripts(a),b()}.bind(this),g=[],h=0,i=function(a){g.push(a),h-=1,0===h&&(e?(this.emit(this.externalChannel,{type:"ready"}),this.tryLoad(f,g)):this.tryLoad(f,g).then(function(){this.emit(this.externalChannel,{type:"ready"})}.bind(this)))}.bind(this);if(this.config.global.importScripts||(e=!1,f=function(a,b){var c=this.config.global.document.createElement("script");c.src=a,c.addEventListener("load",b,!0),this.config.global.document.body.appendChild(c)}.bind(this)),"string"==typeof b)h=1,d.resources.get(a,b).then(i);else for(h=b.length,c=0;c<b.length;c+=1)d.resources.get(a,b[c]).then(i)},d.port.ModuleInternal.prototype.tryLoad=function(a,b){var c,e=[];try{for(c=0;c<b.length;c+=1)e.push(new Promise(a.bind({},b[c])))}catch(f){d.debug.warn(f.stack),d.debug.error("Error loading "+b[c],f),d.debug.error("If the stack trace is not useful, see https://github.com/UWNetworksLab/freedom/wiki/Debugging-Script-Parse-Errors")}return Promise.all(e)},"undefined"==typeof d&&(d={}),d.port=d.port||{},d.port.Provider=function(a){this.id=d.port.Proxy.nextId(),d.util.handleEvents(this),this.definition=a,this.mode=d.port.Provider.mode.synchronous,this.channels={},this.iface=null,this.providerCls=null,this.providerInstances={}},d.port.Provider.mode={synchronous:0,asynchronous:1,promises:2},d.port.Provider.prototype.onMessage=function(a,b){if("control"===a&&b.reverse)this.channels[b.name]=b.channel,this.emit(b.channel,{type:"channel announcement",channel:b.reverse}),this.emit("start");else if("control"===a&&"setup"===b.type)this.controlChannel=b.channel;else if("control"===a&&"close"===b.type)b.channel===this.controlChannel&&delete this.controlChannel,this.close();else{if(!this.channels[a]&&b.channel)return this.channels[a]=b.channel,void this.emit("start");
if(!this.channels[a])return void d.debug.warn("Message from unconfigured source: "+a);if("close"===b.type&&b.to)delete this.providerInstances[a][b.to];else if(b.to&&this.providerInstances[a]&&this.providerInstances[a][b.to])b.message.to=b.to,this.providerInstances[a][b.to](b.message);else if(b.to&&b.message&&"construct"===b.message.type){var c=d.proxy.portableToMessage(this.definition.constructor?this.definition.constructor.value:[],b.message);this.providerInstances[a]||(this.providerInstances[a]={}),this.providerInstances[a][b.to]=this.getProvider(a,b.to,c)}else d.debug.warn(this.toString()+" dropping message "+JSON.stringify(b))}},d.port.Provider.prototype.close=function(){this.controlChannel&&(this.emit(this.controlChannel,{type:"Provider Closing",request:"close"}),delete this.controlChannel),this.emit("close"),this.providerInstances={},this.emitChannel=null},d.port.Provider.prototype.getInterface=function(){return this.iface?this.iface:(this.iface={provideSynchronous:function(a){this.providerCls=a,this.mode=d.port.Provider.mode.synchronous}.bind(this),provideAsynchronous:function(a){this.providerCls=a,this.mode=d.port.Provider.mode.asynchronous}.bind(this),providePromises:function(a){this.providerCls=a,this.mode=d.port.Provider.mode.promises}.bind(this),close:function(){this.close()}.bind(this)},d.util.eachProp(this.definition,function(a,b){switch(a.type){case"constant":Object.defineProperty(this.iface,b,{value:d.proxy.recursiveFreezeObject(a.value),writable:!1})}}.bind(this)),this.iface)},d.port.Provider.prototype.getProxyInterface=function(){var a=function(a){return a.getInterface()}.bind({},this);return a.close=function(a){a?d.util.eachProp(this.ifaces,function(b,c){return b===a?(this.teardown(c),this.emit(this.emitChannel,{type:"close",to:c}),!0):void 0}.bind(this)):this.close()}.bind(this),a.onClose=function(a,b){return"function"==typeof a&&void 0===b?void this.once("close",a):void d.util.eachProp(this.ifaces,function(c,d){return c===a?(this.handlers[d]?this.handlers[d].push(b):this.handlers[d]=[b],!0):void 0}.bind(this))}.bind(this),a},d.port.Provider.prototype.getProvider=function(a,b,c){if(!this.providerCls)return d.debug.warn("Cannot instantiate provider, since it is not provided"),null;var e,f,g,h={};return d.util.eachProp(this.definition,function(a,b){"event"===a.type&&(h[b]=a)}),e=function(a,b,c,e,f){if(b[e]){var g=d.proxy.messageToPortable(b[e].value,f);this.emit(this.channels[a],{type:"message",to:c,message:{name:e,type:"event",text:g.text,binary:g.binary}})}}.bind(this,a,h,b),f=this.providerCls.bind.apply(this.providerCls,[this.providerCls,e].concat(c||[])),g=new f,function(a,b,c){if("method"===c.action){if("function"!=typeof this[c.type])return void d.debug.warn("Provider does not implement "+c.type+"()!");var e=a.definition[c.type],f=d.proxy.portableToMessage(e.value,c),h=function(a,b,c,e,f){var g=d.proxy.messageToPortable(c.ret,e);this.emit(this.channels[a],{type:"method",to:b.to,message:{to:b.to,type:"method",reqId:b.reqId,name:b.type,text:g.text,binary:g.binary,error:f}})}.bind(a,b,c,e);if(Array.isArray(f)||(f=[f]),a.mode===d.port.Provider.mode.synchronous)try{h(this[c.type].apply(this,f))}catch(i){h(void 0,i.message)}else a.mode===d.port.Provider.mode.asynchronous?this[c.type].apply(g,f.concat(h)):a.mode===d.port.Provider.mode.promises&&this[c.type].apply(this,f).then(h,h.bind({},void 0))}}.bind(g,this,a)},d.port.Provider.prototype.toString=function(){return this.emitChannel?"[Provider "+this.emitChannel+"]":"[unbound Provider]"},"undefined"==typeof d&&(d={}),d.port=d.port||{},d.port.Proxy=function(a){this.id=d.port.Proxy.nextId(),this.interfaceCls=a,d.util.handleEvents(this),this.ifaces={},this.closeHandlers={},this.errorHandlers={},this.emits={}},d.port.Proxy.prototype.onMessage=function(a,b){if("control"===a&&b.reverse)this.emitChannel=b.channel,this.emit(this.emitChannel,{type:"channel announcement",channel:b.reverse}),this.emit("start");else if("control"===a&&"setup"===b.type)this.controlChannel=b.channel;else if("control"===a&&"close"===b.type)delete this.controlChannel,this.doClose();else{if(!this.emitChannel&&b.channel)return this.emitChannel=b.channel,void this.emit("start");if("close"===b.type&&b.to)return void this.teardown(b.to);if("error"===b.type)return void this.error(b.to,b.message);b.to?this.emits[b.to]?this.emits[b.to]("message",b.message):d.debug.warn("Could not deliver message, no such interface: "+b.to):(b.message,d.util.eachProp(this.emits,function(a){a("message",b.message)}))}},d.port.Proxy.prototype.getInterface=function(){var a=this.getInterfaceConstructor(),b=Array.prototype.slice.call(arguments,0);return new(a=a.bind.apply(a,[a].concat(b)))},d.port.Proxy.prototype.getProxyInterface=function(){var a=function(a){var b=Array.prototype.slice.call(arguments,1);return a.getInterface(b)}.bind({},this);return a.close=function(a){a?d.util.eachProp(this.ifaces,function(b,c){return b===a?(this.teardown(c),this.emit(this.emitChannel,{type:"close",to:c}),!0):void 0}.bind(this)):this.doClose()}.bind(this),a.onClose=function(a,b){return"function"==typeof a&&void 0===b?void this.once("close",a):void d.util.eachProp(this.ifaces,function(c,d){return c===a?(this.closeHandlers[d]?this.closeHandlers[d].push(b):this.closeHandlers[d]=[b],!0):void 0}.bind(this))}.bind(this),a.onError=function(a,b){return"function"==typeof a&&void 0===b?void this.on("error",a):void d.util.eachProp(this.ifaces,function(c,d){return c===a?(this.errorHandlers[d]?this.errorHandlers[d].push(b):this.errorHandlers[d]=[b],!0):void 0}.bind(this))}.bind(this),a},d.port.Proxy.prototype.getInterfaceConstructor=function(){var a=d.port.Proxy.nextId();return this.interfaceCls.bind({},function(a,b,c){this.ifaces[a]=b,this.emits[a]=c}.bind(this,a),this.doEmit.bind(this,a))},d.port.Proxy.prototype.doEmit=function(a,b,c){c&&(a=!1),this.emitChannel?this.emit(this.emitChannel,{to:a,type:"message",message:b}):this.once("start",this.doEmit.bind(this,a,b))},d.port.Proxy.prototype.teardown=function(a){delete this.emits[a],this.closeHandlers[a]&&d.util.eachProp(this.closeHandlers[a],function(a){a()}),delete this.ifaces[a],delete this.closeHandlers[a],delete this.errorHandlers[a]},d.port.Proxy.prototype.error=function(a,b){a&&this.errorHandlers[a]?d.util.eachProp(this.errorHandlers[a],function(a){a(b)}):a||this.emit("error",b)},d.port.Proxy.prototype.doClose=function(){this.controlChannel&&this.emit(this.controlChannel,{type:"Channel Closing",request:"close"}),d.util.eachProp(this.emits,function(a,b){this.teardown(b)}.bind(this)),this.emit("close"),this.off(),this.emitChannel=null},d.port.Proxy.prototype.toString=function(){return this.emitChannel?"[Proxy "+this.emitChannel+"]":"[unbound Proxy]"},d.port.Proxy.nextId=function(){return d.port.Proxy.id||(d.port.Proxy.id=1),d.port.Proxy.id+=1},"undefined"==typeof d&&(d={});var h=function(){this.files={},this.resolvers=[this.httpResolver,this.nullResolver],this.contentRetrievers={http:this.xhrRetriever,https:this.xhrRetriever,"chrome-extension":this.xhrRetriever,resource:this.xhrRetriever,chrome:this.xhrRetriever,manifest:this.manifestRetriever}};h.prototype.get=function(a,b){var c=JSON.stringify([a,b]);return new Promise(function(d,e){this.files[c]?d(this.files[c]):this.resolve(a,b).then(function(a,b,c){this.files[a]=c,b(c)}.bind(this,c,d),e)}.bind(this))},h.prototype.getContents=function(a){return new Promise(function(b,c){var e;if(!a)return d.debug.warn("Asked to get contents of undefined URL."),c();for(e in this.contentRetrievers)if(this.contentRetrievers.hasOwnProperty(e)&&0===a.indexOf(e+"://"))return this.contentRetrievers[e](a,b,c);c()}.bind(this))},h.prototype.resolve=function(a,b){return new Promise(function(c,e){var f=[];return void 0===b?e():(d.util.eachReverse(this.resolvers,function(c){f.push(new Promise(c.bind({},a,b)))}.bind(this)),void Promise.all(f).then(function(d){var f;for(f=0;f<d.length;f+=1)if("undefined"!=typeof d[f]&&d[f]!==!1)return void c(d[f]);e("No resolvers to handle url: "+JSON.stringify([a,b]))}))}.bind(this))},h.prototype.addResolver=function(a){this.resolvers.push(a)},h.prototype.addRetriever=function(a,b){return this.contentRetrievers[a]?void d.debug.warn("Unwilling to override file retrieval for "+a):void(this.contentRetrievers[a]=b)},h.hasScheme=function(a,b){var c;for(c=0;c<a.length;c+=1)if(0===b.indexOf(a[c]+"://"))return!0;return!1},h.removeRelativePath=function(a){var b,c,d,e=a.indexOf("://")+3;for(a=a.replace(/\/\.\//g,"/");"/"===a.charAt(e);)a=a.slice(0,e)+a.slice(e+1,a.length);for(e=a.indexOf("/",e),b=a.substr(e+1).split("/");-1!==b.indexOf("..");)c=b.indexOf(".."),0===c?b.shift():b.splice(c-1,2);for(d=a.substr(0,e),e=0;e<b.length;e+=1)d+="/"+b[e];return d},h.prototype.httpResolver=function(a,b,c){var d,e,f,g,i,j=["http","https","chrome","chrome-extension","resource"];return h.hasScheme(j,b)?(c(h.removeRelativePath(b)),!0):a&&h.hasScheme(j,a)&&-1===b.indexOf("://")?(d=a.substr(0,a.lastIndexOf("/")),e=d.indexOf("://"),f=e+3+d.substr(e+3).indexOf("/"),g=d.substr(f),i=d.substr(0,f),c(h.removeRelativePath(0===b.indexOf("/")?i+b:i+g+"/"+b)),!0):(c(!1),!1)},h.prototype.nullResolver=function(a,b,c){var d=["manifest","data;base64"];return h.hasScheme(d,b)?(c(b),!0):(c(!1),!1)},h.prototype.manifestRetriever=function(a,b,c){var e;try{e=a.substr(11),JSON.parse(e),b(e)}catch(f){d.debug.warn("Invalid manifest URL referenced:"+a),c()}},h.prototype.xhrRetriever=function(a,b,c){var e=new XMLHttpRequest;e.addEventListener("readystatechange",function(b,c){4===e.readyState&&e.responseText?b(e.responseText):4===e.readyState&&(d.debug.warn("Failed to load file "+a+": "+e.status),c(e.status))}.bind({},b,c),!1),e.overrideMimeType("application/json"),e.open("GET",a,!0),e.send()},d.resources=new h,"undefined"==typeof d&&(d={}),d.util={},d.util.eachReverse=function(a,b){if(a){var c;for(c=a.length-1;c>-1&&(!a[c]||!b(a[c],c,a));c-=1);}},d.util.hasProp=function(a,b){return Object.prototype.hasOwnProperty.call(a,b)},d.util.eachProp=function(a,b){var c;for(c in a)if(a.hasOwnProperty(c)&&b(a[c],c))break},d.util.mixin=function(a,b,c){return b&&d.util.eachProp(b,function(b,e){(c||!d.util.hasProp(a,e))&&(a[e]=b)}),a},d.util.getId=function(){var a,b="guid",c=12;if("object"==typeof crypto)a=new Uint8Array(c),crypto.getRandomValues(a),d.util.eachReverse(a,function(a){b+="-"+a});else for(;c>0;)b+="-"+Math.ceil(255*Math.random()),c-=1;return b},d.util.handleEvents=function(a){var b,c,d={multiple:{},maybemultiple:[],single:{},maybesingle:[]};b=function(a,b){var c,d=[];if(!a||!a.length)return[];for(c=a.length-1;c>=0;c-=1)b(a[c])&&d.push(a.splice(c,1));return d},c=function(a,b,c){"function"==typeof b?this["maybe"+a].push([b,c]):this[a][b]?this[a][b].push(c):this[a][b]=[c]},a.on=c.bind(d,"multiple"),a.once=c.bind(d,"single"),a.emit=function(a,b){var c,d;if(this.multiple[a])for(c=0;c<this.multiple[a].length;c+=1)if(this.multiple[a][c](b)===!1)return;if(this.single[a])for(d=this.single[a],this.single[a]=[],c=0;c<d.length;c+=1)d[c](b);for(c=0;c<this.maybemultiple.length;c+=1)this.maybemultiple[c][0](a,b)&&this.maybemultiple[c][1](b);for(c=this.maybesingle.length-1;c>=0;c-=1)this.maybesingle[c][0](a,b)&&(d=this.maybesingle.splice(c,1),d[0][1](b))}.bind(d),a.off=function(a,c){return a?("function"==typeof a&&(b(this.maybesingle,function(b){return b[0]===a&&(!c||b[1]===c)}),b(this.maybemultiple,function(b){return b[0]===a&&(!c||b[1]===c)})),void(c?(b(this.multiple[a],function(a){return a===c}),b(this.single[a],function(a){return a===c})):(delete this.multiple[a],delete this.single[a]))):(this.multiple={},this.maybemultiple=[],this.single={},void(this.maybesingle=[]))}.bind(d)},/*!@preserve StartModuleContextDeclaration*/
d.util.isModuleContext=function(){return"undefined"==typeof document},d.util.forceModuleContext=function(a){var b,c,e="function () { return true; }",f=a.indexOf("StartModuleContextDeclaration"),g=a.indexOf("function",f);return-1===f||-1===g?void d.debug.error("Unable to force mode, source is in unexpected condition."):(b=a.substr(0,g)+e+" || "+a.substr(g),c=d.util.getBlob(b,"text/javascript"),d.util.getURL(c))},d.util.getBlob=function(a,b){if("function"!=typeof Blob&&"undefined"!=typeof WebKitBlobBuilder){var c=new WebKitBlobBuilder;return c.append(a),c.getBlob(b)}return new Blob([a],{type:b})},d.util.getURL=function(a){return"object"!=typeof URL&&"undefined"!=typeof webkitURL?webkitURL.createObjectURL(a):URL.createObjectURL(a)},d.util.advertise=function(a){"undefined"!=typeof location?"chrome-extension:"!==location.protocol&&"chrome:"!==location.protocol&&"resource:"!==location.protocol&&!a||"undefined"==typeof freedomcfg||freedomcfg(d.apis.register.bind(d.apis)):a&&"undefined"!=typeof freedomcfg&&freedomcfg(d.apis.register.bind(d.apis))},d.util.scripts=function(global){return global.document.getElementsByTagName("script")},"undefined"==typeof d&&(d={}),d.link=d.link||{},d.link.Direct=function(){d.Link.call(this)},d.link.Direct.prototype.start=function(){if(this.config.moduleContext)this.config.global.directLink.other=this,this.other=this.config.global.directLink,this.other.emit("started");else{this.config.global.directLink=this;var a=d.debug,b=d.setup(this.config.global,void 0,{isModule:!0,portType:"Direct"});d.debug=a,this.config.global.freedom=b}},d.link.Direct.prototype.stop=function(){this===this.config.global.directLink&&delete this.config.global.directLink,delete this.other},d.link.Direct.prototype.toString=function(){return"[Direct"+this.id+"]"},d.link.Direct.prototype.deliverMessage=function(a,b){this.other?("control"===a&&(a=this.other.controlChannel),setTimeout(this.other.emit.bind(this.other,a,b),0)):this.once("started",this.onMessage.bind(this,a,b))},"undefined"==typeof d&&(d={}),d.link=d.link||{},d.link.Frame=function(){d.Link.call(this)},d.link.Frame.prototype.start=function(){this.config.moduleContext?(this.config.global.DEBUG=!0,this.setupListener(),this.src="in"):(this.setupFrame(),this.src="out")},d.link.Frame.prototype.stop=function(){},d.link.Frame.prototype.toString=function(){return"[Frame"+this.id+"]"},d.link.Frame.prototype.setupListener=function(){var a=function(a){"in"!==a.data.src&&this.emitMessage(a.data.flow,a.data.message)}.bind(this);this.obj=this.config.global,this.obj.addEventListener("message",a,!0),this.stop=function(){this.obj.removeEventListener("message",a,!0),delete this.obj},this.emit("started")},d.link.Frame.prototype.setupFrame=function(){var a,b;a=this.makeFrame(this.config.src,this.config.inject),document.body||document.appendChild(document.createElement("body")),document.body.appendChild(a),b=function(a,b){this.obj||(this.obj=a,this.emit("started")),"out"!==b.data.src&&this.emitMessage(b.data.flow,b.data.message)}.bind(this,a.contentWindow),a.contentWindow.addEventListener("message",b,!0),this.stop=function(){a.contentWindow.removeEventListener("message",b,!0),this.obj&&delete this.obj,a.src="about:blank",document.body.removeChild(a)}},d.link.Frame.prototype.makeFrame=function(a,b){var c,e,f=document.createElement("iframe"),g="";return a=a.replace('portType: "Worker"','portType: "Frame"'),b&&(g='<script src="'+b+'" onerror="throw new Error(\'Injection of '+b+" Failed!');\"></script>"),c="<html>"+g+'<script src="'+d.util.forceModuleContext(a)+'"></script></html>',e=d.util.getBlob(c,"text/html"),f.src=d.util.getURL(e),f},d.link.Frame.prototype.deliverMessage=function(a,b){this.obj?this.obj.postMessage({src:this.src,flow:a,message:b},"*"):this.once("started",this.onMessage.bind(this,a,b))},"undefined"==typeof d&&(d={}),d.link=d.link||{},d.link.Worker=function(a){a&&(this.manifest=a.substr(a.lastIndexOf("/")+1)),d.Link.call(this)},d.link.Worker.prototype.start=function(){this.config.moduleContext?this.setupListener():this.setupWorker()},d.link.Worker.prototype.stop=function(){},d.link.Worker.prototype.toString=function(){return"[Worker"+this.id+"]"},d.link.Worker.prototype.setupListener=function(){var a=function(a){this.emitMessage(a.data.flow,a.data.message)}.bind(this);this.obj=this.config.global,this.obj.addEventListener("message",a,!0),this.stop=function(){this.obj.removeEventListener("message",a,!0),delete this.obj},this.emit("started")},d.link.Worker.prototype.setupWorker=function(){var a,b;typeof f.Blob!=typeof Function?a=new Worker(this.config.source):(b=new f.Blob([this.config.src],{type:"text/javascript"}),a=new Worker(f.URL.createObjectURL(b)+"#"+this.manifest)),a.addEventListener("error",function(a){d.debug.error(a,this.toString())},!0),a.addEventListener("message",function(a,b){this.obj||(this.obj=a,this.emit("started")),this.emitMessage(b.data.flow,b.data.message)}.bind(this,a),!0),this.stop=function(){a.stop(),this.obj&&delete this.obj}},d.link.Worker.prototype.deliverMessage=function(a,b){"control"===a&&"close"===b.type&&"control"===b.channel?this.stop():this.obj?this.obj.postMessage({flow:a,message:b}):this.once("started",this.onMessage.bind(this,a,b))},"undefined"==typeof d&&(d={}),d.proxy=d.proxy||{},d.proxy.ApiInterface=function(a,b,c){var e={},f=null,g=null,h=0,i=arguments;d.util.eachProp(a,function(a,b){switch(a.type){case"method":this[b]=function(){var f=h,g=new Promise(function(b,c){e[f]={resolve:b,reject:c,template:a.ret}}),i=d.proxy.messageToPortable(a.value,arguments);return h+=1,c({action:"method",type:b,reqId:f,text:i.text,binary:i.binary}),g};break;case"event":f||(d.util.handleEvents(this),g=this.emit,delete this.emit,f={}),f[b]=a;break;case"constant":Object.defineProperty(this,b,{value:d.proxy.recursiveFreezeObject(a.value),writable:!1})}}.bind(this)),b(this,function(a,b){if("close"===a)return this.off(),void delete this.inflight;if(b)if("method"===b.type)if(e[b.reqId]){var c=e[b.reqId],h=c.template;delete e[b.reqId],b.error?c.reject(b.error):c.resolve(d.proxy.portableToMessage(h,b))}else d.debug.warn("Dropped response message with id "+b.reqId);else"event"===b.type&&f[b.name]&&g(b.name,d.proxy.portableToMessage(f[b.name].value,b))}.bind(this)),i=d.proxy.messageToPortable(a.constructor?a.constructor.value:[],Array.prototype.slice.call(i,3)),c({type:"construct",text:i.text,binary:i.binary})},d.proxy.messageToPortable=function(a,b){var c=[],e=d.proxy.conform(a,b,c,!0);return{text:e,binary:c}},d.proxy.portableToMessage=function(a,b){return d.proxy.conform(a,b.text,b.binary,!1)},d.proxy.conform=function(a,b,c,e){if("function"==typeof b)return void 0;if("undefined"==typeof b||void 0===a)return void 0;if(null===b)return null;switch(a){case"string":return String("")+b;case"number":return Number(1)*b;case"boolean":return Boolean(b===!0);case"object":return"undefined"==typeof b?void 0:JSON.parse(JSON.stringify(b));case"blob":return e?b instanceof Blob?(c.push(b),c.length-1):(d.debug.warn("conform expecting Blob, sees "+typeof b),c.push(new Blob([])),c.length-1):c[b];case"buffer":return e?(c.push(d.proxy.makeArrayBuffer(b)),c.length-1):d.proxy.makeArrayBuffer(c[b]);case"proxy":return b}var f,g;if(Array.isArray(a)&&void 0!==b){if(f=[],g=0,2===a.length&&"array"===a[0])for(g=0;g<b.length;g+=1)f.push(d.proxy.conform(a[1],b[g],c,e));else for(g=0;g<a.length;g+=1)f.push(void 0!==b[g]?d.proxy.conform(a[g],b[g],c,e):void 0);return f}return"object"==typeof a&&void 0!==b?(f={},d.util.eachProp(a,function(a,g){void 0!==b[g]&&(f[g]=d.proxy.conform(a,b[g],c,e))}),f):void d.debug.warn("Unknown template type: "+a)},d.proxy.makeArrayBuffer=function(a){return a?a instanceof ArrayBuffer?a:"ArrayBuffer"===a.constructor.name&&"undefined"==typeof a.prototype?new DataView(a).buffer:(d.debug.warn("expecting ArrayBuffer, but saw "+typeof a+": "+JSON.stringify(a)),new ArrayBuffer(0)):new ArrayBuffer(0)},d.proxy.recursiveFreezeObject=function(a){var b,c={};if("object"!=typeof a)return a;for(b in a)a.hasOwnProperty(b)&&Object.defineProperty(c,b,{value:d.proxy.recursiveFreezeObject(a[b]),writable:!1,enumerable:!0});return c},"undefined"==typeof d&&(d={}),d.proxy=d.proxy||{},d.proxy.EventInterface=function(a,b){d.util.handleEvents(this),a(this,function(a,b,c){a(c.type,c.message)}.bind(this,this.emit)),this.emit=function(a,b,c){a({type:b,message:c},!0)}.bind({},b)},d.apis.set("core",{createChannel:{type:"method",value:[],ret:{channel:"proxy",identifier:"string"}},bindChannel:{type:"method",value:["string"],ret:"proxy"},getId:{type:"method",value:[],ret:["array","string"]}}),d.apis.set("core.view",{open:{type:"method",value:["string",{file:"string",code:"string"}]},show:{type:"method",value:[]},close:{type:"method",value:[]},postMessage:{type:"method",value:["object"]},message:{type:"event",value:"object"},onClose:{type:"event",value:[]}}),d.apis.set("core.storage",{keys:{type:"method",value:[],ret:["array","string"]},get:{type:"method",value:["string"],ret:"string"},set:{type:"method",value:["string","string"],ret:"string"},remove:{type:"method",value:["string"],ret:"string"},clear:{type:"method",value:[]}}),d.apis.set("core.tcpsocket",{constructor:{value:["number"]},getInfo:{type:"method",value:[],ret:{connected:"boolean",localAddress:"string",localPort:"number",peerAddress:"string",peerPort:"number"}},close:{type:"method",value:[],err:{errcode:"string",message:"string"}},onDisconnect:{type:"event",value:{errcode:"string",message:"string"}},connect:{type:"method",value:["string","number"],err:{errcode:"string",message:"string"}},write:{type:"method",value:["buffer"],err:{errcode:"string",message:"string"}},onData:{type:"event",value:{data:"buffer"}},listen:{type:"method",value:["string","number"],err:{errcode:"string",message:"string"}},onConnection:{type:"event",value:{socket:"number",host:"string",port:"number"}}}),d.apis.set("core.udpsocket",{bind:{type:"method",value:["string","number"],ret:"number"},getInfo:{type:"method",value:[],ret:{localAddress:"string",localPort:"number"}},sendTo:{type:"method",value:["buffer","string","number"],ret:"number"},destroy:{type:"method",value:[]},onData:{type:"event",value:{resultCode:"number",address:"string",port:"number",data:"buffer"}}}),d.apis.set("core.runtime",{createApp:{type:"method",value:["string","proxy"]},resolve:{type:"method",value:["string","string"]},needFile:{type:"event",value:["string","string"]}}),d.apis.set("core.echo",{setup:{type:"method",value:["string"]},send:{type:"method",value:["string"]},message:{type:"event",value:"string"}}),d.apis.set("core.peerconnection",{setup:{type:"method",value:["string","string",["array","string"],"boolean"]},send:{type:"method",value:[{channelLabel:"string",text:"string",binary:"blob",buffer:"buffer"}]},onReceived:{type:"event",value:{channelLabel:"string",text:"string",binary:"blob",buffer:"buffer"}},openDataChannel:{type:"method",value:["string"]},closeDataChannel:{type:"method",value:["string"]},onOpenDataChannel:{type:"event",value:{channelId:"string"}},onCloseDataChannel:{type:"event",value:{channelId:"string"}},getBufferedAmount:{type:"method",value:["string"],ret:"number"},getInfo:{type:"method",value:[],ret:"string"},close:{type:"method",value:[]},onClose:{type:"event",value:{}}}),d.apis.set("core.websocket",{constructor:{value:["string",["array","string"]]},send:{type:"method",value:[{text:"string",binary:"blob",buffer:"buffer"}],err:{errcode:"string",message:"string"}},getReadyState:{type:"method",value:[],ret:"number"},getBufferedAmount:{type:"method",value:["string"],ret:"number"},close:{type:"method",value:["number","string"],err:{errcode:"string",message:"string"}},onMessage:{type:"event",value:{text:"string",binary:"blob",buffer:"buffer"}},onOpen:{type:"event",value:[]},onError:{type:"event",value:{errcode:"string",message:"string"}},onClose:{type:"event",value:{code:"number",reason:"string",wasClean:"boolean"}}}),d.apis.set("social",{ERRCODE:{type:"constant",value:{SUCCESS:"Success!",UNKNOWN:"Unknown error",OFFLINE:"User is currently offline",LOGIN_BADCREDENTIALS:"Error authenticating with server",LOGIN_FAILEDCONNECTION:"Error connecting to server",LOGIN_ALREADYONLINE:"User is already logged in",SEND_INVALIDDESTINATION:"Message sent to an invalid destination"}},STATUS:{type:"constant",value:{OFFLINE:"OFFLINE",ONLINE:"ONLINE",ONLINE_WITH_OTHER_APP:"ONLINE_WITH_OTHER_APP"}},login:{type:"method",value:[{agent:"string",version:"string",url:"string",interactive:"boolean",rememberLogin:"boolean"}],ret:{userId:"string",clientId:"string",status:"string",timestamp:"number"},err:{errcode:"string",message:"string"}},clearCachedCredentials:{type:"method",value:[]},getClients:{type:"method",value:[],ret:"object",err:{errcode:"string",message:"string"}},getUsers:{type:"method",value:[],ret:"object",err:{errcode:"string",message:"string"}},sendMessage:{type:"method",value:["string","string"],err:{errcode:"string",message:"string"}},logout:{type:"method",value:[],err:{errcode:"string",message:"string"}},onMessage:{type:"event",value:{from:{userId:"string",clientId:"string",status:"string",timestamp:"number"},message:"string"}},onUserProfile:{type:"event",value:{userId:"string",timestamp:"number",name:"string",url:"string",imageData:"string"}},onClientState:{type:"event",value:{userId:"string",clientId:"string",status:"string",timestamp:"number"}}}),d.apis.set("storage",{scope:{type:"constant",value:{SESSION:0,DEVICE_LOCAL:1,USER_LOCAL:2,SHARED:3}},constructor:{value:[{scope:"number"}]},keys:{type:"method",value:[],ret:["array","string"]},get:{type:"method",value:["string"],ret:"string"},set:{type:"method",value:["string","string"],ret:"string"},remove:{type:"method",value:["string"],ret:"string"},clear:{type:"method",value:[]}}),d.apis.set("transport",{setup:{type:"method",value:["string","proxy"]},send:{type:"method",value:["string","buffer"]},close:{type:"method",value:[]},onData:{type:"event",value:{tag:"string",data:"buffer"}},onClose:{type:"event",value:[]}});var i=function(a){this.manager=a};i.unboundChannels={},i.contextId=void 0,i.prototype.createChannel=function(a){var b=new d.port.Proxy(d.proxy.EventInterface),c=d.util.getId(),e=this.getChannel(b);this.manager.setup(b),this.manager.delegate&&this.manager.toDelegate.core&&this.manager.emit(this.manager.delegate,{type:"Delegation",request:"handle",flow:"core",message:{type:"register",id:c}}),i.unboundChannels[c]={local:!0,proxy:b},b.once("start",this.getChannel.bind(this,b)),a({channel:e,identifier:c})},i.prototype.getChannel=function(a){var b=a.getProxyInterface(),c=b();return c.close=b.close,c.onClose=b.onClose,b.onClose(c,function(){a.doClose()}),c},i.prototype.onMessage=function(a,b){"register"===b.type?i.unboundChannels[b.id]={remote:!0,resolve:b.reply,source:a}:"clear"===b.type?delete i.unboundChannels[b.id]:"bind"===b.type&&i.unboundChannels[b.id]&&this.bindChannel(b.id,function(){},a)},i.prototype.bindChannel=function(a,b,c){var e=i.unboundChannels[a],f=!c;if(f&&(d.debug.log("making local proxy for core binding"),c=new d.port.Proxy(d.proxy.EventInterface),this.manager.setup(c)),e&&e.local)d.debug.log("doing local binding with "+c),this.manager.createLink(c,a,e.proxy,"default"),delete i.unboundChannels[a],this.manager.delegate&&this.manager.toDelegate.core&&this.manager.emit(this.manager.delegate,{type:"Delegation",request:"handle",flow:"core",message:{type:"clear",id:a}});else{if(!e||!e.remote)return this.manager.delegate&&this.manager.toDelegate.core?(d.debug.warn("delegating bind request for unseen ID:"+a),this.manager.emit(this.manager.delegate,{type:"Delegation",request:"handle",flow:"core",message:{type:"bind",id:a}}),c.once("start",function(a,b){b(this.getChannel(a))}.bind(this,c,b)),this.manager.createLink(c,"default",this.manager.hub.getDestination(this.manager.delegate),a),void delete i.unboundChannels[a]):(d.debug.warn("Asked to bind unknown channel: "+a),d.debug.log(i.unboundChannels),void b());d.debug.log("doing remote binding downward"),this.manager.createLink(c,f?"default":a,e.source,a),e.resolve({type:"Bind Channel",request:"core",flow:"core",message:{type:"bind",id:a}}),delete i.unboundChannels[a]}c.getInterface?b(this.getChannel(c)):b()},i.prototype.getId=function(a){a(i.contextId)},i.prototype.setId=function(a){i.contextId=a},d.apis.register("core",i);var j=function(a,b){d.debug.log("Echo Created!"),this.mod=a,this.dispatchEvent=b,d.util.handleEvents(this),this.mod.once("core",function(a){this.core=new a}.bind(this)),this.mod.emit(this.mod.controlChannel,{type:"core request delegated to echo",request:"core"})};j.prototype.setup=function(a,b){return b(),this.core?void this.core.bindChannel(a,function(a){this.chan&&this.chan.close(),this.chan=a,this.chan.onClose(function(){delete this.chan}.bind(this)),this.dispatchEvent("message","channel bound to echo"),this.chan.on("message",function(a){this.dispatchEvent("message","from custom channel: "+a)}.bind(this))}.bind(this)):void this.dispatchEvent("message","no core available to setup proxy with at echo")},j.prototype.send=function(a,b){b(),this.chan?this.chan.emit("message",a):this.dispatchEvent("message","no channel available")},d.apis.register("core.echo",j);var k={DISCONNECTED:"DISCONNECTED",CONNECTING:"CONNECTING",CONNECTED:"CONNECTED"};b.prototype.runWhenConnected=function(a){this.pcState===k.CONNECTED?a():this.onConnectedQueue.push(a)},b.prototype.send=function(a,b,c){this.channels[a].send(b),c()},b.prototype.openDataChannel=function(a,b){var c=this.pc.createDataChannel(a,{});c.onopen=function(){this.addDataChannel(a,c),b()}.bind(this),c.onerror=function(a){console.error(a),b(void 0,a)},"undefined"!=typeof mozRTCPeerConnection&&this.pcState===k.DISCONNECTED&&this.negotiateConnection()},b.prototype.closeChannel=function(a){void 0!==this.channels[a]&&(this.channels[a].close(),delete this.channels[a])},b.prototype.getBufferedAmount=function(a){if(void 0!==this.channels[a]){var b=this.channels[a];return b.bufferedAmount}throw new Error("No channel with id: "+a)},b.prototype.setSendSignalMessage=function(a){this.sendSignalMessage=a},b.prototype.handleSignalMessage=function(a){var b=JSON.parse(a);if(b.sdp)this.pc.setRemoteDescription(new this.RTCSessionDescription(b.sdp),function(){"offer"===this.pc.remoteDescription.type&&this.pc.createAnswer(this.onDescription.bind(this),console.error)}.bind(this),function(a){console.error(this.peerName+": setRemoteDescription failed:",a)}.bind(this));else if(b.candidate){var c=new this.RTCIceCandidate(b.candidate);this.pc.addIceCandidate(c)}else console.warn(this.peerName+": handleSignalMessage got unexpected message: ",a)},b.prototype.negotiateConnection=function(){this.pcState=k.CONNECTING,this.pc.createOffer(this.onDescription.bind(this),function(a){console.error(this.peerName+": createOffer failed: ",a.toString()),this.pcState=k.DISCONNECTED}.bind(this))},b.prototype.isClosed=function(){return!this.pc||"closed"===this.pc.signalingState},b.prototype.close=function(){this.isClosed()||this.pc.close()},b.prototype.addDataChannel=function(a,b){var c=this.dataChannelCallbacks;this.channels[a]=b,"connecting"===b.readyState&&(b.onopen=c.onOpenFn.bind(this,b,{label:a})),b.onclose=c.onCloseFn.bind(this,b,{label:a}),b.onmessage=c.onMessageFn.bind(this,b,{label:a}),b.onerror=c.onErrorFn.bind(this,b,{label:b})},b.prototype.onDescription=function(a){this.sendSignalMessage?this.pc.setLocalDescription(a,function(){this.sendSignalMessage(JSON.stringify({sdp:a}))}.bind(this),function(a){console.error(this.peerName+": setLocalDescription failed:",a)}.bind(this)):console.error(this.peerName+": _onDescription: _sendSignalMessage is not set, so we did not set the local description. ")},b.prototype.onNegotiationNeeded=function(){if(this.pcState!==k.DISCONNECTED){var a=function(){return function(){}.bind(this)}.bind(this),b=function(){return function(){}.bind(this)}.bind(this);return void(this.pc.localDescription&&this.pc.remoteDescription&&"offer"===this.pc.localDescription.type?(this.pc.setLocalDescription(this.pc.localDescription,a("setLocalDescription"),b("setLocalDescription")),this.pc.setRemoteDescription(this.pc.remoteDescription,a("setRemoteDescription"),b("setRemoteDescription"))):this.pc.localDescription&&this.pc.remoteDescription&&"answer"===this.pc.localDescription.type?(this.pc.setRemoteDescription(this.pc.remoteDescription,a("setRemoteDescription"),b("setRemoteDescription")),this.pc.setLocalDescription(this.pc.localDescription,a("setLocalDescription"),b("setLocalDescription"))):console.error(this.peerName+", onNegotiationNeeded failed"))}this.negotiateConnection()},b.prototype.onIceCallback=function(a){a.candidate&&(this.sendSignalMessage?this.sendSignalMessage(JSON.stringify({candidate:a.candidate})):console.warn(this.peerName+": _onDescription: _sendSignalMessage is not set."))},b.prototype.onSignalingStateChange=function(){"stable"===this.pc.signalingState&&(this.pcState=k.CONNECTED,this.onConnectedQueue.map(function(a){a()}))},b.prototype.onDataChannel=function(a){this.addDataChannel(a.channel.label,a.channel),"open"===a.channel.readyState&&this.dataChannelCallbacks.onOpenFn(a.channel,{label:a.channel.label})},c.prototype.setup=function(a,c,d,e,f){this.peerName=c;var g={RTCPeerConnection:this.RTCPeerConnection,RTCSessionDescription:this.RTCSessionDescription,RTCIceCandidate:this.RTCIceCandidate},h=this,i={onOpenFn:function(a,b){h.dispatchEvent("onOpenDataChannel",b.label)},onCloseFn:function(a,b){h.dispatchEvent("onCloseDataChannel",{channelId:b.label})},onMessageFn:function(a,b,c){c.data instanceof ArrayBuffer?h.dispatchEvent("onReceived",{channelLabel:b.label,buffer:c.data}):c.data instanceof Blob?h.dispatchEvent("onReceived",{channelLabel:b.label,binary:c.data}):"string"==typeof c.data&&h.dispatchEvent("onReceived",{channelLabel:b.label,text:c.data})},onErrorFn:function(a,b,c){console.error(a.peerName+": dataChannel("+a.dataChannel.label+"): error: ",c)}};if(this.peer=new b(this.peerName,d,i,g),this.core.bindChannel(a,function(a){this.signallingChannel=a,this.peer.setSendSignalMessage(function(a){this.signallingChannel.emit("message",a)}.bind(this)),this.signallingChannel.on("message",this.peer.handleSignalMessage.bind(this.peer)),this.signallingChannel.emit("ready"),e||this.peer.runWhenConnected(f)}.bind(this)),e){console.log(this.peerName+" initiating connection");var j="hello"+Math.random().toString(),k=function(a,b){b?f(void 0,b):this.closeDataChannel(j,f)}.bind(this);this.openDataChannel(j,k)}},c.prototype.openDataChannel=function(a,b){this.peer.openDataChannel(a,b)},c.prototype.closeDataChannel=function(a,b){this.peer.closeChannel(a),b()},c.prototype.send=function(a,b){var c=a.text||a.buffer||a.binary;return"undefined"==typeof c?void console.error("No valid data to send has been provided.",a):void this.peer.send(a.channelLabel,c,b)},c.prototype.getBufferedAmount=function(a,b){b(this.peer.getBufferedAmount(a))},c.prototype.close=function(a){return this.peer.isClosed()?void a():(this.peer.close(),this.dispatchEvent("onClose"),void a())},d.apis.register("core.peerconnection",c);var l=function(a){this.app=a,d.util.handleEvents(this)};l.prototype.keys=function(a){var b,c=[];for(b=0;b<localStorage.length;b+=1)c.push(localStorage.key(b));a(c)},l.prototype.get=function(a,b){try{var c=localStorage.getItem(a);b(c)}catch(d){b(null)}},l.prototype.set=function(a,b,c){localStorage.setItem(a,b),c()},l.prototype.remove=function(a,b){localStorage.removeItem(a),b()},l.prototype.clear=function(a){localStorage.clear(),a()},d.apis.register("core.storage",l);var m=function(a,b){this.dispatchEvent=b,this.host=null,this.win=null,this.app=a,d.util.handleEvents(this)};m.prototype.open=function(a,b,c){this.host=document.createElement("div"),this.host.style.width="100%",this.host.style.height="100%",this.host.style.display="relative";var e,f,g=document.body,h=this.app.manifest.views;h&&h[a]&&document.getElementById(a)&&(g=document.getElementById(a)),g.appendChild(this.host),e=this.host,f=document.createElement("iframe"),f.setAttribute("sandbox","allow-scripts allow-forms"),b.file?d.resources.get(this.app.manifestId,b.file).then(function(a){this.finishOpen(e,f,a,c)}.bind(this)):b.code?this.finishOpen(e,f,"data:text/html;charset=utf-8,"+b.code,c):c(!1)},m.prototype.finishOpen=function(a,b,c,d){b.src=c,b.style.width="100%",b.style.height="100%",b.style.border="0",b.style.background="transparent",a.appendChild(b),this.app.config.global.addEventListener("message",this.onMessage.bind(this),!0),this.win=b,d({})},m.prototype.show=function(a){a()},m.prototype.postMessage=function(a,b){this.win.contentWindow.postMessage(a,"*"),b()},m.prototype.close=function(a){this.host&&(this.host.parentNode.removeChild(this.host),this.host=null),this.win&&(this.app.config.global.removeEventListener("message",this.onMessage.bind(this),!0),this.win=null),a()},m.prototype.onMessage=function(a){a.source===this.win.contentWindow&&this.dispatchEvent("message",a.data)},d.apis.register("core.view",m);var n=function(a,b,c,d,e){var f=e||WebSocket;this.dispatchEvent=b;try{this.websocket=d?new f(c,d):new f(c)}catch(g){var h={};return h.errcode=g instanceof SyntaxError?"SYNTAX":g.name,h.message=g.message,void b("onError",h)}this.websocket.onopen=this.onOpen.bind(this),this.websocket.onclose=this.onClose.bind(this),this.websocket.onmessage=this.onMessage.bind(this),this.websocket.onerror=this.onError.bind(this)};n.prototype.send=function(a,b){var c,d,e=a.text||a.binary||a.buffer;if(e)try{this.websocket.send(e)}catch(f){c=f instanceof SyntaxError?"SYNTAX":"INVALID_STATE",d=f.message}else c="BAD_SEND",d="No text, binary, or buffer data found.";c?b(void 0,{errcode:c,message:d}):b()},n.prototype.getReadyState=function(a){a(this.websocket.readyState)},n.prototype.getBufferedAmount=function(a){a(this.websocket.bufferedAmount)},n.prototype.close=function(a,b,c){try{a&&b?this.websocket.close(a,b):this.websocket.close(),c()}catch(d){var e;e=d instanceof SyntaxError?"SYNTAX":"INVALID_ACCESS",c(void 0,{errcode:e,message:d.message})}},n.prototype.onOpen=function(){this.dispatchEvent("onOpen")},n.prototype.onMessage=function(a){var b={};a.data instanceof ArrayBuffer?b.buffer=b:a.data instanceof Blob?b.binary=b:"string"==typeof a.data&&(b.text=a.data),this.dispatchEvent("onMessage",b)},n.prototype.onError=function(){this.dispatchEvent("onError")},n.prototype.onClose=function(a){this.dispatchEvent("onClose",{code:a.code,reason:a.reason,wasClean:a.wasClean})},d.apis.register("core.websocket",n),global.freedom=d.setup(global,e)}}()}(this);
//# sourceMappingURL=freedom.min.map